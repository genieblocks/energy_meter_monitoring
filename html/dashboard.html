<!DOCTYPE html>
<html class="loading" lang="en" data-textdirection="ltr">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
  <meta name="description" content="GenieBlocks Cloud Platform is flexable IoT platform that manage your devices.">
  <meta name="keywords" content="GenieBlocks, IoT Platform, cloud, IoT device, edge device, ota, secure, aiot">
  <meta name="author" content="GenieBlocks">
  <title>GenieBlocks Cloud Platform</title>
  <link rel="apple-touch-icon" href="../app-assets/images/ico/apple-icon-120.png">
  <link rel="shortcut icon" type="image/x-icon" href="../app-assets/images/ico/favicon.ico">
  <link
    href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i%7CMuli:300,400,500,700"
    rel="stylesheet">
    
  <!-- BEGIN VENDOR CSS-->
  <link rel="stylesheet" type="text/css" href="../app-assets/css/bootstrap.css">
  <link rel="stylesheet" type="text/css" href="../app-assets/vendors/css/tables/datatable/jquery.dataTables.min.css">
  <!-- font icons-->
  <link rel="stylesheet" type="text/css" href="../app-assets/fonts/icomoon.css">
  <link rel="stylesheet" type="text/css" href="../app-assets/vendors/css/sliders/slick/slick.css">
  <link rel="stylesheet" type="text/css" href="../app-assets/vendors/css/extensions/pace.css">
  <link rel="stylesheet" type="text/css" href="../app-assets/fonts/feather/style.min.css">
  <link rel="stylesheet" type="text/css" href="../app-assets/fonts/font-awesome/css/font-awesome.min.css">
  <!-- END VENDOR CSS-->
  <!-- BEGIN TEMPLATE CSS-->
  <link rel="stylesheet" type="text/css" href="../app-assets/css/bootstrap-extended.css">
  <link rel="stylesheet" type="text/css" href="../app-assets/css/app.css">
  <link rel="stylesheet" type="text/css" href="../app-assets/css/colors.css">
  <link rel="stylesheet" type="text/css" href="../app-assets/css/components.css">
  <!-- END TEMPLATE CSS-->
  <!-- BEGIN Page Level CSS-->
  <link rel="stylesheet" type="text/css" href="../app-assets/css/core/menu/menu-types/vertical-menu.css">
  <!-- END Page Level CSS-->
  <!-- BEGIN Custom CSS-->
  <link rel="stylesheet" type="text/css" href="../assets/css/fonts/google/font-google.css">
  <link rel="stylesheet" type="text/css" href="../assets/css/style.css">
  <!-- END Custom CSS-->
</head>

<body class="vertical-layout vertical-menu 2-columns menu-collapsed" data-open="click" data-menu="vertical-menu"
  data-col="2-columns">

  <!-- ////////////////////////////////////////////////////////////////////////////-->


  <div class="main-menu menu-fixed menu-dark menu-accordion menu-shadow" data-scroll-to-active="true">
    <div class="main-menu-content">
      <ul class="navigation navigation-main" id="main-menu-navigation" data-menu="menu-navigation">
        <li class="nav-item"><a style="padding-left: 9px" href="#">
            <img class="brand-logo" alt="GenieBlocks logo" src="../app-assets/images/logo/logo-light-sm.png">
            <span class="mt-1" data-i18n="">
              <h3 class="brand-text"><span class="white">&nbsp;&nbsp;&nbsp;&nbsp;Genie</span><span
                  class="font-weight-bold blue accent-4">Blocks</span></h3>
            </span>
          </a>
        </li>
        <li class="active"><a href="dashboard.html"><i class="icon-home3"></i><span class="menu-title"
          data-i18n="">Durum Panosu</span></a>
        </li>
        <li class="nav-item"><a href="consumption-overview.html"><i class="icon-stats-dots"></i><span class="menu-title"
          data-i18n="">Tüketim İzleme</span></a>
        </li>
        <li class="nav-item"><a href="consumption-reports.html"><i class="fa fa-clipboard"></i><span class="menu-title"
            data-i18n="">Tüketim Raporları</span></a>
        </li>
        <li class="nav-item"><a href="devices-device-list.html"><i class="icon-sliders"></i><span class="menu-title"
          data-i18n="">Sayaç Yönetimi</span></a>
        </li>
      </ul>
    </div>
  </div>

  <div class="app-content content bg-white">
    <div class="content-body">
      <nav
        class="header-navbar navbar-expand-md navbar navbar-with-menu navbar-light navbar-border navbar-brand-center">
        <div class="navbar-wrapper">
          <div class="navbar-header">
            <ul class="nav navbar-nav flex-row">
              <li class="nav-item mobile-menu d-md-none mr-auto"><a
                  class="nav-link nav-menu-main menu-toggle hidden-xs is-active" href="#"><i
                    class="ft-menu font-large-1"></i></a></li>
              <li class="nav-item d-md-none"><a class="navbar-brand" href="#"><img class="brand-logo"
                    alt="genieblocks logo" src="../app-assets/images/logo/logo-light-sm.png">
                </a></li>
              <li class="nav-item d-md-none"><a class="nav-link open-navbar-container collapsed" data-toggle="collapse"
                  data-target="#navbar-mobile" aria-expanded="false"><i class="fa fa-ellipsis-v"></i></a></li>
            </ul>
          </div>
          <div class="navbar-container content">
            <div class="collapse navbar-collapse" id="navbar-mobile">
              <ul class="nav navbar-nav mr-auto float-left">
                <li class="nav-item d-none d-md-block"><a class="nav-link nav-menu-main menu-toggle hidden-xs" 
                    href="#"><i class="ft-menu"></i></a>
                </li>
                <li class="nav-item"><a class="nav-link" href="#" role="button" aria-haspopup="true" 
                    aria-expanded="false">Durum Panosu</a>
                </li>
              </ul>
              <ul class="nav navbar-nav float-right">
                <li class="dropdown dropdown-notification nav-item"><a href="#" data-toggle="dropdown" class="nav-link nav-link-label"><i class="ficon icon-bell4"></i><span class="badge badge-pill badge-default badge-danger badge-default badge-up">5</span></a>
                    <ul class="dropdown-menu dropdown-menu-media dropdown-menu-right">
                      <li class="dropdown-menu-header">
                        <h6 class="dropdown-header m-0"><span class="grey darken-2">BİLDİRİMLER</span></h6><span class="notification-tag badge badge-default badge-danger float-right m-0">5 Yeni</span>
                      </li>

                      <li class="scrollable-container media-list w-100">
                        <a href="javascript:void(0)">
                            <div class="media">
                                <div class="media-left align-self-center"><i class="ft-download-cloud icon-bg-circle bg-red bg-darken-1"></i></div>
                                <div class="media-body">
                                  <h6 class="media-heading">Elektrik sayaç saat hatası</h6>
                                  <p class="notification-text font-small-3 text-muted">Lorem ipsum dolor sit amet, consectetuer elit.</p>
                                    <small><time class="media-meta text-muted" datetime="2015-06-11T18:29:20+08:00">30 dakika önce</time></small>
                                </div>
                            </div></a>
                            
                            <a href="javascript:void(0)">
                            <div class="media">
                                <div class="media-left align-self-center"><i class="ft-download-cloud icon-bg-circle bg-red bg-darken-1"></i></div>
                                <div class="media-body">
                                  <h6 class="media-heading red darken-1">Kapasitif enerji limit aşımı</h6>
                                  <p class="notification-text font-small-3 text-muted">Lorem ipsum dolor sit amet, consectetuer elit.</p>
                                    <small><time class="media-meta text-muted" datetime="2015-06-11T18:29:20+08:00">5 saat önce</time></small>
                                </div>
                            </div></a>
                            
                            <a href="javascript:void(0)">
                            <div class="media">
                                <div class="media-left align-self-center"><i class="ft-alert-triangle icon-bg-circle bg-yellow bg-darken-3"></i></div>
                                <div class="media-body">
                                  <h6 class="media-heading yellow darken-3">Jeneratör devrede</h6>
                                  <p class="notification-text font-small-3 text-muted">Lorem ipsum dolor sit amet, consectetuer elit.</p>
                                    <small><time class="media-meta text-muted" datetime="2015-06-11T18:29:20+08:00">Bugün</time></small>
                                </div>
                            </div></a>
                            
                            <a href="javascript:void(0)">
                            <div class="media">
                                <div class="media-left align-self-center"><i class="ft-plus-square icon-bg-circle bg-cyan"></i></div>
                                <div class="media-body">
                                  <h6 class="media-heading">Jeneratör devre dışı</h6>
                                    <small><time class="media-meta text-muted" datetime="2015-06-11T18:29:20+08:00">Gecen hafta</time></small>
                                </div>
                            </div></a>

                          <a href="javascript:void(0)">
                            <div class="media">
                            <div class="media-left align-self-center"><i class="icon-bar-graph-2 icon-bg-circle bg-teal"></i></div>
                            <div class="media-body">
                                <h6 class="media-heading">Aylık rapor oluşturuldu</h6>
                                <small><time class="media-meta text-muted" datetime="2015-06-11T18:29:20+08:00">Gecen ay</time></small>
                            </div>
                          </div></a>
                        </li>
                      <li class="dropdown-menu-footer"><a class="dropdown-item text-muted text-center" href="javascript:void(0)">Tüm bildirimleri gör</a></li>
                    </ul>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </nav>
      <div class="content-wrapper" style="background-color: #f5f5f5;">
        <section id="card-overlay">

          <div class="row">
            <div class="col-xl-8 col-md-8 col-sm-12 left-card">
              <div class="card">
                <div class="card-content">
                  <div id="image-map-pro"></div>
                </div>
              </div>
            </div>
            <div class="col-xl-4 col-md-4 col-sm-12 right-cards">
              <div class="card half-card" style="height: 330px;">
                  <div class="card-header no-border">
                      <h4 class="card-title">Cihaz Raporu</h4>
                      <p class="card-subtitle text-muted pt-1">
                        <span class="font-small-3">05 Mart 2025 08:00</span>
                      </p>
                      <a class="heading-elements-toggle"><i class="ft-more-horizontal font-medium-3"></i></a>
                      <div class="heading-elements">
                          <ul class="list-inline mb-0">
                              <li><button id="list-button" class="btn btn-sm btn-genie">Listele</button></li>
                          </ul>
                      </div>
                  </div>
                  <div class="card-content">
                      <div id="audience-list-scroll" class="table-responsive height-300 position-relative">
                          <table class="table mb-0">
                              <tbody>
                                    <tr>
                                        <td>Online Elektrik Sayaç Sayısı</td>
                                        <td class="text-center font-small-2 w-50">
                                            <span id="count-electricity">0/0</span>
                                            <div class="progress mt-1 mb-0" style="height: 7px;">
                                                <div id="progress-electricity" class="progress-bar bg-success" role="progressbar" style="width: 0%" aria-valuemin="0" aria-valuemax="100"></div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Online Su Sayaç Sayısı</td>
                                        <td class="text-center font-small-2 w-50">
                                            <span id="count-water">0/0</span>
                                            <div class="progress mt-1 mb-0" style="height: 7px;">
                                                <div id="progress-water" class="progress-bar bg-success" role="progressbar" style="width: 0%" aria-valuemin="0" aria-valuemax="100"></div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Online Kalorimetre Sıcak Sayaç Sayısı</td>
                                        <td class="text-center font-small-2 w-50">
                                            <span id="count-hot_calorimeter">0/0</span>
                                            <div class="progress mt-1 mb-0" style="height: 7px;">
                                                <div id="progress-hot_calorimeter" class="progress-bar bg-success" role="progressbar" style="width: 0%" aria-valuemin="0" aria-valuemax="100"></div>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Online Kalorimetre Soğuk Sayaç Sayısı</td>
                                        <td class="text-center font-small-2 w-50">
                                            <span id="count-cold_calorimeter">0/0</span>
                                            <div class="progress mt-1 mb-0" style="height: 7px;">
                                                <div id="progress-cold_calorimeter" class="progress-bar bg-success" role="progressbar" style="width: 0%" aria-valuemin="0" aria-valuemax="100"></div>
                                            </div>
                                        </td>
                                    </tr>
                                    <!-- <tr>
                                        <td>Online Moxa Sayısı</td>
                                        <td class="text-center font-small-2 w-50">
                                            8/10
                                            <div class="progress mt-1 mb-0" style="height: 7px;">
                                                <div class="progress-bar bg-success" role="progressbar" style="width: 80%" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>
                                            </div>
                                        </td>
                                    </tr> -->
                              </tbody>
                          </table>
                        <div id="offline-meters-list" class="mt-2"></div>
                      </div>
                  </div>
              </div>
              <div class="card half-card" style="height: 400px;">
                    <div class="card-header no-border">
                        <h4 class="card-title">Jeneratör Durumu</h4>
                        <p class="card-subtitle text-muted pt-1">
                          <span class="font-small-3">Son 15 Dakika</span>
                        </p>
                        <a class="heading-elements-toggle"><i class="ft-more-horizontal font-medium-3"></i></a>
                        <div class="heading-elements">
                        <ul class="list-inline mb-0">
                              <li>
                                <button class="btn btn-sm btn-genie" data-toggle="modal" data-target="#generatorEventsModal">Geçmiş Olaylar</button>
                              </li>
                          </ul>
                        </div>
                    </div>
                    <div class="card-content">
                        <div class="card-body" style="height: 320px;">
                            <div id="generator-status-chart" style="height: 100%;"></div>
                        </div>
                    </div>
                </div>
            </div>
          </div>

          <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-content">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-xl-3 col-lg-6 col-md-12 border-right-grey border-right-lighten-3 clearfix">
                                  <div class="pb-1">
                                    <div class="d-flex align-items-center">
                                      <div class="pl-2">
                                        <span class="grey darken-1 block">Elektrik</span>
                                        <span class="font-large-3 line-height-1 text-bold-300">25</span>
                                      </div>
                                      <span class="ml-auto grey darken-1 block">MWh</span>
                                    </div>
                                    <div class="progress mt-1" style="height: 7px;">
                                      <div class="progress-bar bg-info" role="progressbar" style="width: 80%;" aria-valuenow="80" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                  </div>
                                </div>

                                <div class="col-xl-3 col-lg-6 col-md-12 border-right-grey border-right-lighten-3 clearfix">
                                  <div class="pb-1">
                                    <div class="d-flex align-items-center">
                                      <div class="pl-2">
                                        <span class="grey darken-1 block">Su</span>
                                        <span class="font-large-3 line-height-1 text-bold-300">185</span>
                                      </div>
                                      <span class="ml-auto grey darken-1 block">m³</span>
                                    </div>
                                    <div class="progress mt-1" style="height: 7px;">
                                      <div class="progress-bar bg-danger" role="progressbar" style="width: 45%;" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                  </div>
                                </div>

                                <div class="col-xl-3 col-lg-6 col-md-12 border-right-grey border-right-lighten-3 clearfix">
                                  <div class="pb-1">
                                    <div class="d-flex align-items-center">
                                      <div class="pl-2">
                                        <span class="grey darken-1 block">Kalorimetre(Sıcak)</span>
                                        <span class="font-large-3 line-height-1 text-bold-300">64</span>
                                      </div>
                                      <div class="float-left mt-2">
                                        <span class="grey darken-1 block">MWh</span>
                                        <span class="block"><i class="ft-arrow-down deep-orange accent-3"></i></span>
                                      </div>
                                    </div>
                                    <div class="progress mt-1" style="height: 7px;">
                                      <div class="progress-bar bg-success" role="progressbar" style="width: 75%;" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                  </div>
                                </div>

                                <div class="col-xl-3 col-lg-6 col-md-12 clearfix">
                                  <div class="pb-1">
                                    <div class="d-flex align-items-center">
                                      <div class="pl-2">
                                        <span class="grey darken-1 block">Kalorimetre(Soğuk)</span>
                                        <span class="font-large-3 line-height-1 text-bold-300">22.3</span>
                                      </div>
                                      <div class="float-left mt-2">
                                        <span class="grey darken-1 block">MWh</span>
                                        <span class="block"><i class="ft-arrow-up success"></i></span>
                                      </div>
                                    </div>
                                    <div class="progress mt-1" style="height: 7px;">
                                      <div class="progress-bar bg-warning" role="progressbar" style="width: 60%;" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                  </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
          </div>

        </section>
      </div>
    </div>
  </div>
  <!-- ////////////////////////////////////////////////////////////////////////////-->

  <footer class="footer footer-static footer-light navbar-border">
        <p class="clearfix blue-grey lighten-2 text-sm-center mb-0 px-2">
            <span class="float-md-left d-block d-md-inline-block">
                Copyright &copy; <span id="footer-dynamic-year"></span> <a class="text-bold-800 darken-2"
                href="http://www.genieblocks.com" target="_blank">GenieBlocks</a>, All rights reserved.
            </span>
            <span class="float-md-none d-block d-md-inline-block red">Production</span>
            <span class="float-md-right d-block d-md-inline-block d-none d-lg-block">Made with <i
                class="ft-heart pink"></i></span>
        </p>
  </footer>
  
  <!-- Offline Devices Modal -->
  <div class="modal fade" id="offlineDevicesModal" tabindex="-1" role="dialog" aria-labelledby="offlineDevicesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="offlineDevicesModalLabel">Offline Cihazlar</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="offlineDevicesTabs" class="btn-group btn-group-toggle d-flex justify-content-center" data-toggle="buttons">
                        <button class="btn btn-outline-info active" data-type="electricity">Elektrik Sayaçları</button>
                        <button class="btn btn-outline-info" data-type="hot_calorimeter">Kalorimetre Sıcak Sayaçları</button>
                        <button class="btn btn-outline-info" data-type="cold_calorimeter">Kalorimetre Soğuk Sayaçları</button>
                        <button class="btn btn-outline-info" data-type="water">Su Sayaçları</button>
                    </div>
                    <div id="offlineDevicesContent" class="mt-3">
                        <!-- İçerik buraya eklenecek -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Kapat</button>
                </div>
            </div>
        </div>
    </div>
  
  <!-- BEGIN VENDOR JS-->  
  <script src="../app-assets/vendors/js/ui/popper.min.js"></script>

  <script src="../app-assets/js/core/libraries/jquery.min.js"></script>
  <script src="../app-assets/vendors/js/ui/tether.min.js"></script>
  <script src="../app-assets/js/core/libraries/bootstrap.min.js"></script>
  <script src="../app-assets/vendors/js/ui/perfect-scrollbar.jquery.min.js"></script>
  <script src="../app-assets/vendors/js/ui/unison.min.js"></script>
  <script src="../app-assets/vendors/js/ui/blockUI.min.js"></script>
  <script src="../app-assets/vendors/js/ui/jquery.matchHeight-min.js"></script>
  <script src="../app-assets/vendors/js/sliders/slick/slick.min.js"></script>
  <script src="../app-assets/vendors/js/ui/screenfull.min.js"></script>
  <!-- END VENDOR JS-->
  <!-- BEGIN PAGE VENDOR JS-->
  <script src="../assets/js/image-map-pro.min.js"></script>
  <script src="../app-assets/vendors/js/charts/plotly-latest.min.js"></script>
  <script src="../app-assets/vendors/js/tables/datatable/datatables.min.js"></script>
  <!-- END PAGE VENDOR JS-->
  <!-- BEGIN TEMPLATE JS-->
  <script src="../app-assets/js/core/app-menu.js"></script>
  <script src="../app-assets/js/core/app.js"></script>
  <!-- END TEMPLATE JS-->
  <!-- BEGIN PAGE LEVEL JS-->
  <script src="../app-assets/js/scripts/extensions/block-ui.js"></script>
  <script src="../app-assets/js/scripts/modal/components-modal.js"></script>
  <!-- END PAGE LEVEL JS-->

<script>
  // const baseWebhookURL = "http://127.0.0.1:5678"; // Değiştirmek istediğiniz temel URL
  const baseWebhookURL = "http://192.168.2.250:5678"; // Değiştirmek istediğiniz temel URL
  // const baseWebhookURL = "http://192.168.1.146:5678"; // Değiştirmek istediğiniz temel URL

  const baseURL = "http://192.168.2.250";
</script>
<script>
/* ========================= Block Functions ========================= */
function blockElementById(elementId, message = " Yükleniyor...") {
  $(elementId).block({
    message: `<div class="icon-spinner9 icon-spin icon-lg"></div>${message}`,
    overlayCSS: {
      backgroundColor: '#fff',
      opacity: 0.8,
      cursor: 'wait'
    },
    css: {
      border: 0,
      padding: 0,
      backgroundColor: 'transparent',
      color: '#000',
      fontSize: '14px'
    }
  });
}

function unblockElementById(elementId) {
  $(elementId).unblock();
}

function updateMeterReport() {
    let contentContainer = document.getElementById("offlineDevicesContent");
    let tabsContainer = document.getElementById("offlineDevicesTabs");

    if (!contentContainer || !tabsContainer) {
        console.error("Offline devices modal elements not found.");
        return;
    }

    fetch(`${baseWebhookURL}/webhook/get-unreadable-meters-list`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log("Fetch Response:", data); // Fetch cevabını konsola bas
        if (data.length > 0) {
            let queryStartTime = new Date(data[0].queryStartTime);
            let formattedTime = queryStartTime.toLocaleString("tr-TR", {
                year: "numeric",
                month: "long",
                day: "numeric",
                hour: "2-digit",
                minute: "2-digit",
                timeZone: "UTC" // Saat farkını engellemek için UTC kullan
            });
            document.querySelector(".card-subtitle span").textContent = formattedTime;
        }
        const meterTypes = {
            electricity: "Elektrik Sayaçları",
            hot_calorimeter: "Kalorimetre Sıcak Sayaçları",
            cold_calorimeter: "Kalorimetre Soğuk Sayaçları",
            water: "Su Sayaçları"
        };

        let onlineMeters = {
            electricity: 0,
            hot_calorimeter: 0,
            cold_calorimeter: 0,
            water: 0
        };

        let totalMeters = {
            electricity: 0,
            hot_calorimeter: 0,
            cold_calorimeter: 0,
            water: 0
        };

        let offlineMeters = {
            electricity: [],
            hot_calorimeter: [],
            cold_calorimeter: [],
            water: []
        };

        // Veriyi ayrıştır ve offline sayaçları belirle
        data.forEach(meter => {
            const { type, totalCount, offlineCount, offlineDevices } = meter;

            if (meterTypes[type]) {
                totalMeters[type] = totalCount;
                onlineMeters[type] = totalCount - offlineCount;
                
                // Eğer offlineDevices string olarak geldiyse, diziye çevir
                if (typeof offlineDevices === "string") {
                    offlineMeters[type] = offlineDevices.split(", ").map(serial => serial.trim());
                } else if (Array.isArray(offlineDevices)) {
                    offlineMeters[type] = offlineDevices;
                } else {
                    offlineMeters[type] = [];
                }
            }
        });

        // **Progress bar ve sayaç sayılarını güncelle**
        Object.keys(meterTypes).forEach(type => {
            const progress = document.getElementById(`progress-${type}`);
            const countText = document.getElementById(`count-${type}`);

            if (progress && countText) {
                let percentage = totalMeters[type] > 0 
                    ? (onlineMeters[type] / totalMeters[type]) * 100 
                    : 0;
                progress.style.width = `${percentage}%`;
                countText.innerHTML = `${onlineMeters[type]}/${totalMeters[type]}`;
            }
        });

        // **Offline cihaz listesi oluştur**
        tabsContainer.innerHTML = "";
        contentContainer.innerHTML = "";

        let first = true;
        Object.keys(meterTypes).forEach(type => {
            if (offlineMeters[type].length > 0) {
                let btn = document.createElement("button");
                btn.classList.add("btn", "btn-outline-info");
                btn.setAttribute("data-type", type);
                btn.textContent = meterTypes[type];
                if (first) btn.classList.add("active");
                tabsContainer.appendChild(btn);

                let div = document.createElement("div");
                div.id = `offlineDevicesContent-${type}`;
                div.classList.add("offline-devices-table");
                if (!first) div.style.display = "none";

                // Tablo yapısını oluştur
                let table = document.createElement("table");
                table.classList.add("table", "table-striped", "table-bordered", "table-sm");
                let thead = document.createElement("thead");
                let tbody = document.createElement("tbody");

                // Başlık satırı oluştur
                let trHead = document.createElement("tr");
                ["Seri Numarası", "Blok", "Bina No", "Daire", "Abone"].forEach(headerText => {
                    let th = document.createElement("th");
                    th.textContent = headerText;
                    trHead.appendChild(th);
                });
                thead.appendChild(trHead);

                // `offlineDevicesDetails` JSON formatında string olarak geldiği için parse edelim
                let offlineDetails = [];
                data.forEach(meter => {
                    if (meter.type === type && meter.offlineDevicesDetails) {
                        try {
                            let parsedDetails = JSON.parse(meter.offlineDevicesDetails);
                            offlineDetails = offlineDetails.concat(parsedDetails);
                        } catch (error) {
                            console.error("JSON parse hatası:", error);
                        }
                    }
                });

                // Seri numarasına göre sıralama yap
                offlineDetails.sort((a, b) => a.SerialNumber.localeCompare(b.SerialNumber, undefined, { numeric: true }));

                // Her cihaz için satır ekleyelim
                offlineDetails.forEach(device => {
                    let tr = document.createElement("tr");
                    ["SerialNumber", "Block", "BuildingNo", "Flat", "Subscriber"].forEach(key => {
                        let td = document.createElement("td");
                        td.textContent = device[key] || "-";
                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });

                table.appendChild(thead);
                table.appendChild(tbody);
                div.appendChild(table);
                contentContainer.appendChild(div);
                $(`#${div.id} table`).DataTable({
                    dom: 'rt<"bottom"B>',
                    paging: false,
                    autoWidth: false,
                    buttons: [
                        {
                            extend: 'excelHtml5',
                            text: 'Excel Olarak İndir',
                            title: `Offline ${meterTypes[type]} Listesi`,
                            filename: `offline_(${meterTypes[type]})_listesi`
                        }
                    ],
                    destroy: true
                });
                first = false;
            }
        });
        // Ensure header is displayed for the active tab when modal opens
        if (!document.getElementById("offlineDevicesHeader") && tabsContainer.children.length > 0) {
            let header = document.createElement("h5");
            header.id = "offlineDevicesHeader";
            header.classList.add("text-center", "mt-3", "font-weight-bold");
            let activeButton = tabsContainer.querySelector("button.active");
            if (activeButton) {
                header.textContent = activeButton.textContent + " Listesi";
            }
            contentContainer.prepend(header);
        }

        document.getElementById("offlineDevicesTabs").addEventListener("click", function (e) {
            if (e.target.tagName.toLowerCase() !== "button") return;

            console.log("Tıklanan buton:", e.target.textContent);
            
            // Tüm butonlardan "active" sınıfını ve "aria-pressed" özelliğini kaldır
            document.querySelectorAll("#offlineDevicesTabs button").forEach(btn => {
                btn.classList.remove("active");
                btn.setAttribute("aria-pressed", "false");
            });

            // Tıklanan butona "active" sınıfını ekle ve "aria-pressed" değerini true yap
            e.target.classList.add("active");
            e.target.setAttribute("aria-pressed", "true");

            console.log("Seçilen buton active mi?:", e.target.classList.contains("active"));
            
            let selectedType = e.target.getAttribute("data-type");

            // Tüm içerik divlerini gizle
            document.querySelectorAll("#offlineDevicesContent > div").forEach(div => {
                div.style.display = "none";
            });

            // Seçilen tipin içeriğini göster
            let selectedDiv = document.getElementById(`offlineDevicesContent-${selectedType}`);
            if (selectedDiv) {
                selectedDiv.style.display = "block";
            }

            // Başlık güncelleme
            let selectedHeader = document.getElementById("offlineDevicesHeader");
            if (!selectedHeader) {
                selectedHeader = document.createElement("h5");
                selectedHeader.id = "offlineDevicesHeader";
                selectedHeader.classList.add("text-center", "mt-3");
                document.getElementById("offlineDevicesContent").prepend(selectedHeader);
            }
            selectedHeader.textContent = e.target.textContent + " Listesi";

            console.log("Aktif butonlar:", [...document.querySelectorAll("#offlineDevicesTabs button.active")].map(btn => btn.textContent));
        });
    })
    .catch(error => console.error("Error fetching meter data:", error));
}

document.getElementById("list-button").addEventListener("click", () => {
    updateMeterReport();
    $("#offlineDevicesModal").modal("show");
});

document.addEventListener('DOMContentLoaded', () => {
    updateMeterReport();
});

document.addEventListener('DOMContentLoaded', () => {
    const yearElement = document.getElementById('footer-dynamic-year');
    if (yearElement) {
        const currentYear = new Date().getFullYear();
        yearElement.textContent = currentYear;
    }
    updateMeterReport();
});
  </script>
  <script>
      const imageMapProSettings = {
      "id": "6a9b4235-e000-4087-b038-3b68c6f358e5",
      "general": {
          "name": "Akaretler-Sıraevler"
      },
      "fullscreen": {
          "enable_fullscreen_mode": true
      },
      "objectConfig": {
          "pageload_animation": "flash",
          "stop_glowing_on_mouseover": false
      },
      "object_list": {
          "menu_style": "on-top",
          "menu_position": "right"
      },
      "artboards": [{
          "background_type": "image",
          "image_url": "../assets/images/akaretlerGraph.png",
          "width": 1000,
          "height": 625,
          "use_image_size": true,
          "children": [{
              "id": "a2503a61-008d-4542-a85c-ee28d090bbdd",
              "title": "A",
              "type": "poly",
              "x": 1.2933695091391508,
              "y": 48.43342463175456,
              "width": 88.59080188679245,
              "height": 38.85416666666666,
              "default_style": {
                  "background_color": "#ff2600",
                  "background_opacity": 0
              },
              "mouseover_style": {
                  "background_color": "#ffffff",
                  "background_opacity": 0.5,
                  "stroke_width": 2
              },
              "tooltip_content": [{
                  "type": "Heading",
                  "text": "A Blok",
                  "heading": "h3",
                  "other": {
                      "id": "",
                      "classes": "",
                      "css": ""
                  },
                  "style": {
                      "fontFamily": "sans-serif",
                      "fontSize": 20.8,
                      "lineHeight": "normal",
                      "color": "#ffffff",
                      "textAlign": "left"
                  },
                  "boxModel": {
                      "width": "auto",
                      "height": "auto",
                      "margin": {
                          "top": 0,
                          "bottom": 0,
                          "left": 0,
                          "right": 0
                      },
                      "padding": {
                          "top": 10,
                          "bottom": 10,
                          "left": 10,
                          "right": 10
                      }
                  },
                  "id": "dd8d05f5-34df-4065-b563-dd5e05416d13"
              }],
              "actions": {
                  "click": "follow-link",
                  "link":  "",
                  "open_link_in_new_window": false
              },
              "x_image_background": 1.5292185657429245,
              "y_image_background": 48.537591298421226,
              "points": [{
                  "x": 98.06988352745427,
                  "y": 100
              }, {
                  "x": 99.70049916805321,
                  "y": 91.42091152815014
              }, {
                  "x": 100,
                  "y": 81.769436997319
              }, {
                  "x": 98.63560732113143,
                  "y": 79.62466487935656
              }, {
                  "x": 98.801996672213,
                  "y": 72.25201072386062
              }, {
                  "x": 95.84026622296173,
                  "y": 67.69436997319035
              }, {
                  "x": 93.14475873544093,
                  "y": 63.136729222520124
              }, {
                  "x": 90.04991680532446,
                  "y": 57.64075067024129
              }, {
                  "x": 87.05490848585691,
                  "y": 53.351206434316346
              }, {
                  "x": 85.05823627287853,
                  "y": 48.52546916890079
              }, {
                  "x": 83.46089850249584,
                  "y": 47.45308310991955
              }, {
                  "x": 81.6638935108153,
                  "y": 43.83378016085792
              }, {
                  "x": 80.33277870216305,
                  "y": 42.895442359249316
              }, {
                  "x": 78.76871880199668,
                  "y": 39.54423592493298
              }, {
                  "x": 77.57071547420965,
                  "y": 39.276139410187675
              }, {
                  "x": 75.84026622296174,
                  "y": 36.19302949061661
              }, {
                  "x": 74.40931780366056,
                  "y": 36.729222520107236
              }, {
                  "x": 72.67886855241264,
                  "y": 33.51206434316353
              }, {
                  "x": 71.11480865224628,
                  "y": 33.780160857908854
              }, {
                  "x": 69.41763727121462,
                  "y": 30.428954423592497
              }, {
                  "x": 67.35440931780366,
                  "y": 31.50134048257372
              }, {
                  "x": 65.39101497504161,
                  "y": 27.88203753351206
              }, {
                  "x": 63.12811980033278,
                  "y": 29.75871313672923
              }, {
                  "x": 60.69883527454243,
                  "y": 25.603217158176943
              }, {
                  "x": 59.03494176372711,
                  "y": 26.809651474530817
              }, {
                  "x": 57.33777038269551,
                  "y": 23.324396782841827
              }, {
                  "x": 55.77371048252912,
                  "y": 24.396782841823057
              }, {
                  "x": 53.11148086522463,
                  "y": 21.44772117962464
              }, {
                  "x": 51.44758735440931,
                  "y": 22.788203753351205
              }, {
                  "x": 49.11813643926787,
                  "y": 19.571045576407506
              }, {
                  "x": 47.35440931780367,
                  "y": 19.973190348525467
              }, {
                  "x": 45.39101497504159,
                  "y": 17.962466487935654
              }, {
                  "x": 43.26123128119799,
                  "y": 18.498659517426276
              }, {
                  "x": 41.79700499168053,
                  "y": 15.281501340482578
              }, {
                  "x": 40.33277870216306,
                  "y": 15.817694369973182
              }, {
                  "x": 38.13643926788686,
                  "y": 13.136729222520104
              }, {
                  "x": 36.971713810316125,
                  "y": 13.270777479892764
              }, {
                  "x": 35.540765391014986,
                  "y": 12.064343163538876
              }, {
                  "x": 33.810316139767046,
                  "y": 12.064343163538876
              }, {
                  "x": 31.547420965058233,
                  "y": 9.919571045576404
              }, {
                  "x": 29.151414309484192,
                  "y": 8.579088471849856
              }, {
                  "x": 28.019966722129787,
                  "y": 10.991957104557631
              }, {
                  "x": 25.956738768718807,
                  "y": 7.506702412868628
              }, {
                  "x": 24.193011647254576,
                  "y": 10.053619302949064
              }, {
                  "x": 22.99500831946755,
                  "y": 6.970509383378006
              }, {
                  "x": 21.164725457570714,
                  "y": 9.3833780160858
              }, {
                  "x": 19.334442595673877,
                  "y": 6.032171581769438
              }, {
                  "x": 17.570715474209653,
                  "y": 7.506702412868628
              }, {
                  "x": 15.973377703826955,
                  "y": 4.021447721179626
              }, {
                  "x": 14.47587354409318,
                  "y": 6.434316353887401
              }, {
                  "x": 12.37936772046589,
                  "y": 3.3512064343163424
              }, {
                  "x": 11.048252911813647,
                  "y": 5.093833780160853
              }, {
                  "x": 9.351081530782032,
                  "y": 2.278820375335115
              }, {
                  "x": 8.352745424292845,
                  "y": 4.289544235924928
              }, {
                  "x": 5.856905158069884,
                  "y": 0
              }, {
                  "x": 0,
                  "y": 12.868632707774802
              }, {
                  "x": 0.26622296173044935,
                  "y": 23.324396782841827
              }, {
                  "x": 1.9966722129783694,
                  "y": 25.469168900804284
              }, {
                  "x": 3.594009983361065,
                  "y": 23.860589812332435
              }, {
                  "x": 4.792013311148087,
                  "y": 25.469168900804284
              }, {
                  "x": 7.121464226289517,
                  "y": 26.675603217158173
              }, {
                  "x": 8.386023294509153,
                  "y": 23.860589812332435
              }, {
                  "x": 8.918469217970049,
                  "y": 27.61394101876674
              }, {
                  "x": 9.983361064891845,
                  "y": 27.61394101876674
              }, {
                  "x": 10.782029950083198,
                  "y": 28.686327077747986
              }, {
                  "x": 12.179700499168053,
                  "y": 28.95442359249329
              }, {
                  "x": 14.54242928452579,
                  "y": 28.284182305630022
              }, {
                  "x": 14.875207986688855,
                  "y": 30.428954423592497
              }, {
                  "x": 16.00665557404326,
                  "y": 30.026809651474533
              }, {
                  "x": 16.70549084858569,
                  "y": 28.15013404825738
              }, {
                  "x": 17.271214642262894,
                  "y": 30.965147453083098
              }, {
                  "x": 19.30116472545757,
                  "y": 31.90348525469168
              }, {
                  "x": 19.434276206322796,
                  "y": 29.22252010723861
              }, {
                  "x": 19.96672212978369,
                  "y": 31.90348525469168
              }, {
                  "x": 22.52911813643927,
                  "y": 32.975871313672926
              }, {
                  "x": 23.427620632279535,
                  "y": 32.43967828418231
              }, {
                  "x": 24.62562396006655,
                  "y": 32.97587131367291
              }, {
                  "x": 25.65723793677205,
                  "y": 33.78016085790884
              }, {
                  "x": 27.85357737104825,
                  "y": 34.45040214477212
              }, {
                  "x": 28.35274542429285,
                  "y": 32.439678284182285
              }, {
                  "x": 30.61564059900167,
                  "y": 32.97587131367291
              }, {
                  "x": 31.813643926788682,
                  "y": 33.51206434316353
              }, {
                  "x": 32.57903494176374,
                  "y": 35.25469168900804
              }, {
                  "x": 33.51081530782031,
                  "y": 35.92493297587131
              }, {
                  "x": 34.975041597337764,
                  "y": 36.99731903485255
              }, {
                  "x": 36.07321131447588,
                  "y": 37.26541554959784
              }, {
                  "x": 37.27121464226289,
                  "y": 38.337801608579085
              }, {
                  "x": 38.469217970049904,
                  "y": 38.73994638069705
              }, {
                  "x": 39.53410981697171,
                  "y": 39.27613941018765
              }, {
                  "x": 40.465890183028286,
                  "y": 40.482573726541546
              }, {
                  "x": 42.56239600665556,
                  "y": 41.55495978552275
              }, {
                  "x": 44.45923460898502,
                  "y": 43.16353887399464
              }, {
                  "x": 45.55740432612313,
                  "y": 43.565683646112596
              }, {
                  "x": 47.254575707154736,
                  "y": 45.30831099195709
              }, {
                  "x": 48.985024958402654,
                  "y": 46.38069705093834
              }, {
                  "x": 50.848585690515804,
                  "y": 47.98927613941019
              }, {
                  "x": 52.4792013311148,
                  "y": 49.061662198391396
              }, {
                  "x": 54.409317803660564,
                  "y": 50.26809651474529
              }, {
                  "x": 54.97504159733776,
                  "y": 49.195710455764036
              }, {
                  "x": 55.64059900166388,
                  "y": 51.206434316353885
              }, {
                  "x": 57.10482529118135,
                  "y": 52.81501340482574
              }, {
                  "x": 58.968386023294514,
                  "y": 52.81501340482574
              }, {
                  "x": 59.633943427620636,
                  "y": 51.7426273458445
              }, {
                  "x": 60.033277870216295,
                  "y": 53.88739946380695
              }, {
                  "x": 61.36439267886854,
                  "y": 53.88739946380695
              }, {
                  "x": 62.56239600665556,
                  "y": 53.88739946380695
              }, {
                  "x": 63.227953410981684,
                  "y": 54.959785522788195
              }, {
                  "x": 64.02662229617304,
                  "y": 58.1769436997319
              }, {
                  "x": 65.75707154742094,
                  "y": 58.1769436997319
              }, {
                  "x": 67.78702163061565,
                  "y": 60.053619302949066
              }, {
                  "x": 69.35108153078203,
                  "y": 61.39410187667559
              }, {
                  "x": 70.7487520798669,
                  "y": 62.73458445040217
              }, {
                  "x": 71.88019966722129,
                  "y": 62.46648793565684
              }, {
                  "x": 72.67886855241264,
                  "y": 64.07506702412869
              }, {
                  "x": 73.61064891846921,
                  "y": 65.1474530831099
              }, {
                  "x": 74.70881863560732,
                  "y": 65.81769436997318
              }, {
                  "x": 76.13976705490849,
                  "y": 67.29222520107238
              }, {
                  "x": 77.07154742096506,
                  "y": 68.09651474530831
              }, {
                  "x": 77.70382695507487,
                  "y": 68.49865951742628
              }, {
                  "x": 78.60232945091515,
                  "y": 69.43699731903484
              }, {
                  "x": 80.06655574043262,
                  "y": 71.84986595174261
              }, {
                  "x": 81.5973377703827,
                  "y": 74.798927613941
              }, {
                  "x": 83.16139767054909,
                  "y": 76.54155495978556
              }, {
                  "x": 84.12645590682196,
                  "y": 76.80965147453085
              }, {
                  "x": 84.79201331114807,
                  "y": 79.89276139410187
              }, {
                  "x": 86.12312811980034,
                  "y": 80.6970509383378
              }, {
                  "x": 86.38935108153079,
                  "y": 81.76943699731905
              }, {
                  "x": 87.45424292845257,
                  "y": 83.64611260053621
              }, {
                  "x": 88.2529118136439,
                  "y": 82.84182305630026
              }, {
                  "x": 88.91846921797003,
                  "y": 84.4504021447721
              }, {
                  "x": 89.48419301164726,
                  "y": 87.26541554959783
              }, {
                  "x": 90.81530782029951,
                  "y": 89.4101876675603
              }, {
                  "x": 92.77870216306157,
                  "y": 91.42091152815014
              }, {
                  "x": 94.84193011647254,
                  "y": 95.97855227882037
              }, {
                  "x": 95.87354409317804,
                  "y": 97.85522788203754
              }]
          }, {
              "id": "ef83d57b-5fd3-4240-9ec8-afc4f47aff83",
              "title": "B1",
              "type": "poly",
              "x": 11.143867924528301,
              "y": 34.89583333333333,
              "width": 16.68632075471698,
              "height": 11.250000000000007,
              "default_style": {
                  "background_color": "#ff2600",
                  "background_opacity": 0
              },
              "mouseover_style": {
                  "background_color": "#ffffff",
                  "background_opacity": 0.5,
                  "stroke_width": 2
              },
              "tooltip_content": [{
                  "type": "Heading",
                  "text": "B1 Blok",
                  "heading": "h3",
                  "other": {
                      "id": "",
                      "classes": "",
                      "css": ""
                  },
                  "style": {
                      "fontFamily": "sans-serif",
                      "fontSize": 20.8,
                      "lineHeight": "normal",
                      "color": "#ffffff",
                      "textAlign": "left"
                  },
                  "boxModel": {
                      "width": "auto",
                      "height": "auto",
                      "margin": {
                          "top": 0,
                          "bottom": 0,
                          "left": 0,
                          "right": 0
                      },
                      "padding": {
                          "top": 10,
                          "bottom": 10,
                          "left": 10,
                          "right": 10
                      }
                  },
                  "id": "e727942f-d12c-43ad-9fc2-084b47c0f757"
              }],
              "actions": {
                  "click": "follow-link",
                  "link": "",
                  "open_link_in_new_window": false
              },
              "x_image_background": 11.143867924528301,
              "y_image_background": 34.89583333333333,
              "points": [{
                  "x": 87.2791519434629,
                  "y": 100
              }, {
                  "x": 86.92579505300354,
                  "y": 48.14814814814816
              }, {
                  "x": 93.9929328621908,
                  "y": 19.444444444444432
              }, {
                  "x": 100,
                  "y": 12.037037037037008
              }, {
                  "x": 61.48409893992933,
                  "y": 6.481481481481456
              }, {
                  "x": 23.321554770318023,
                  "y": 0
              }, {
                  "x": 12.367491166077741,
                  "y": 3.7037037037036806
              }, {
                  "x": 0,
                  "y": 29.629629629629633
              }, {
                  "x": 0.35335689045936736,
                  "y": 75.92592592592592
              }, {
                  "x": 15.724381625441694,
                  "y": 81.94444444444446
              }, {
                  "x": 44.87632508833922,
                  "y": 87.96296296296299
              }, {
                  "x": 58.657243816254415,
                  "y": 93.51851851851855
              }, {
                  "x": 72.96819787985868,
                  "y": 96.29629629629632
              }]
          }, {
              "id": "00e12598-1c33-4c17-9505-1bc148673ba2",
              "title": "B2",
              "type": "poly",
              "x": 25.678066037735853,
              "y": 36.354166666666664,
              "width": 9.168632075471692,
              "height": 11.354166666666671,
              "default_style": {
                  "background_color": "#ff2600",
                  "background_opacity": 0
              },
              "mouseover_style": {
                  "background_color": "#ffffff",
                  "background_opacity": 0.5,
                  "stroke_width": 2
              },
              "tooltip_content": [{
                  "type": "Heading",
                  "text": "B2 Blok",
                  "heading": "h3",
                  "other": {
                      "id": "",
                      "classes": "",
                      "css": ""
                  },
                  "style": {
                      "fontFamily": "sans-serif",
                      "fontSize": 20.8,
                      "lineHeight": "normal",
                      "color": "#ffffff",
                      "textAlign": "left"
                  },
                  "boxModel": {
                      "width": "auto",
                      "height": "auto",
                      "margin": {
                          "top": 0,
                          "bottom": 0,
                          "left": 0,
                          "right": 0
                      },
                      "padding": {
                          "top": 10,
                          "bottom": 10,
                          "left": 10,
                          "right": 10
                      }
                  },
                  "id": "052b185e-c764-4f72-846f-d17de2667c1f"
              }],
              "actions": {
                  "click": "follow-link",
                  "link":  "",
                  "open_link_in_new_window": false
              },
              "x_image_background": 25.707547169811324,
              "y_image_background": 36.354166666666664,
              "points": [{
                  "x": 76.20578778135048,
                  "y": 98.16513761467888
              }, {
                  "x": 75.56270096463017,
                  "y": 35.77981651376145
              }, {
                  "x": 100,
                  "y": 10.091743119266072
              }, {
                  "x": 29.260450160771708,
                  "y": 0
              }, {
                  "x": 13.183279742765244,
                  "y": 5.5045871559633
              }, {
                  "x": 0.3215434083601223,
                  "y": 32.11009174311927
              }, {
                  "x": 0,
                  "y": 85.32110091743115
              }, {
                  "x": 43.40836012861736,
                  "y": 90.82568807339452
              }, {
                  "x": 49.19614147909967,
                  "y": 91.74311926605505
              }, {
                  "x": 59.48553054662378,
                  "y": 81.65137614678898
              }, {
                  "x": 69.77491961414789,
                  "y": 82.56880733944956
              }, {
                  "x": 71.06109324758846,
                  "y": 100
              }]
          }, {
              "id": "3810c818-e331-4e34-886c-6b9c4407a6a4",
              "title": "C1",
              "type": "poly",
              "x": 32.6061320754717,
              "y": 37.291666666666664,
              "width": 13.738207547169814,
              "height": 12.395833333333336,
              "default_style": {
                  "background_color": "#ff2600",
                  "background_opacity": 0
              },
              "mouseover_style": {
                  "background_color": "#ffffff",
                  "background_opacity": 0.5,
                  "stroke_width": 2
              },
              "tooltip_content": [{
                  "type": "Heading",
                  "text": "C1 Blok",
                  "heading": "h3",
                  "other": {
                      "id": "",
                      "classes": "",
                      "css": ""
                  },
                  "style": {
                      "fontFamily": "sans-serif",
                      "fontSize": 20.8,
                      "lineHeight": "normal",
                      "color": "#ffffff",
                      "textAlign": "left"
                  },
                  "boxModel": {
                      "width": "auto",
                      "height": "auto",
                      "margin": {
                          "top": 0,
                          "bottom": 0,
                          "left": 0,
                          "right": 0
                      },
                      "padding": {
                          "top": 10,
                          "bottom": 10,
                          "left": 10,
                          "right": 10
                      }
                  },
                  "id": "bc5335b8-f9e9-4fdc-8e93-a20b5857bcf0"
              }],
              "actions": {
                  "click": "follow-link",
                  "link": "",
                  "open_link_in_new_window": false
              },
              "x_image_background": 32.6061320754717,
              "y_image_background": 37.291666666666664,
              "points": [{
                  "x": 0.4291845493562143,
                  "y": 81.51260504201683
              }, {
                  "x": 0,
                  "y": 24.369747899159677
              }, {
                  "x": 15.450643776824025,
                  "y": 0
              }, {
                  "x": 78.1115879828326,
                  "y": 10.084033613445376
              }, {
                  "x": 99.57081545064379,
                  "y": 15.126050420168063
              }, {
                  "x": 100,
                  "y": 24.369747899159677
              }, {
                  "x": 97.85407725321888,
                  "y": 25.210084033613438
              }, {
                  "x": 87.98283261802574,
                  "y": 41.176470588235325
              }, {
                  "x": 87.55364806866953,
                  "y": 100
              }, {
                  "x": 60.08583690987124,
                  "y": 93.27731092436979
              }, {
                  "x": 30.472103004291835,
                  "y": 86.97478991596643
              }]
          }, {
              "id": "d4a9b324-2b88-43d1-8192-2fa4d1f3e9b3",
              "title": "C2",
              "type": "poly",
              "x": 44.51650943396226,
              "y": 36.666666666666664,
              "width": 13.874056609877101,
              "height": 15.472500015625002,
              "default_style": {
                  "background_color": "#ff2600",
                  "background_opacity": 0
              },
              "mouseover_style": {
                  "background_color": "#ffffff",
                  "background_opacity": 0.5,
                  "stroke_width": 2
              },
              "tooltip_content": [{
                  "type": "Heading",
                  "text": "C2 Blok",
                  "heading": "h3",
                  "other": {
                      "id": "",
                      "classes": "",
                      "css": ""
                  },
                  "style": {
                      "fontFamily": "sans-serif",
                      "fontSize": 20.8,
                      "lineHeight": "normal",
                      "color": "#ffffff",
                      "textAlign": "left"
                  },
                  "boxModel": {
                      "width": "auto",
                      "height": "auto",
                      "margin": {
                          "top": 0,
                          "bottom": 0,
                          "left": 0,
                          "right": 0
                      },
                      "padding": {
                          "top": 10,
                          "bottom": 10,
                          "left": 10,
                          "right": 10
                      }
                  },
                  "id": "0ecc1d20-696a-4d83-83bc-3de2b61be014"
              }],
              "actions": {
                  "click": "follow-link",
                  "link": "",
                  "open_link_in_new_window": false
              },
              "x_image_background": 44.51650943396226,
              "y_image_background": 36.666666666666664,
              "points": [{
                  "x": 0.8499643011254008,
                  "y": 84.8279204184562
              }, {
                  "x": 0,
                  "y": 37.70129796375833
              }, {
                  "x": 9.774589462942314,
                  "y": 26.25626108190311
              }, {
                  "x": 14.44939311913212,
                  "y": 23.56331122734896
              }, {
                  "x": 22.949036130386283,
                  "y": 24.909786154626012
              }, {
                  "x": 22.22826644702424,
                  "y": 9.015995810090448
              }, {
                  "x": 38.21099525337117,
                  "y": 0.31238208214262086
              }, {
                  "x": 57.280794181444136,
                  "y": 0
              }, {
                  "x": 98.46666431278514,
                  "y": 34.647492727708276
              }, {
                  "x": 96.89593032829768,
                  "y": 65.3040339729385
              }, {
                  "x": 99.44582323167388,
                  "y": 72.70964607296247
              }, {
                  "x": 97.32091247886035,
                  "y": 76.74907085479371
              }, {
                  "x": 97.32091247886035,
                  "y": 80.11525817298643
              }, {
                  "x": 100,
                  "y": 86.89610610872506
              }, {
                  "x": 84.44225334421571,
                  "y": 100
              }, {
                  "x": 70.08465654557438,
                  "y": 99.32676253636149
              }, {
                  "x": 42.92319720683361,
                  "y": 92.59438789997607
              }]
          }, {
              "id": "5cc396f0-9afd-45a5-b03c-d52057f1e209",
              "title": "D",
              "type": "poly",
              "x": 26.297169811320757,
              "y": 13.125,
              "width": 25.737028301886788,
              "height": 27.604166666666664,
              "default_style": {
                  "background_color": "#ff2600",
                  "background_opacity": 0
              },
              "mouseover_style": {
                  "background_color": "#ffffff",
                  "background_opacity": 0.5,
                  "stroke_width": 2
              },
              "tooltip_content": [{
                  "type": "Heading",
                  "text": "D Blok",
                  "heading": "h3",
                  "other": {
                      "id": "",
                      "classes": "",
                      "css": ""
                  },
                  "style": {
                      "fontFamily": "sans-serif",
                      "fontSize": 20.8,
                      "lineHeight": "normal",
                      "color": "#ffffff",
                      "textAlign": "left"
                  },
                  "boxModel": {
                      "width": "auto",
                      "height": "auto",
                      "margin": {
                          "top": 0,
                          "bottom": 0,
                          "left": 0,
                          "right": 0
                      },
                      "padding": {
                          "top": 10,
                          "bottom": 10,
                          "left": 10,
                          "right": 10
                      }
                  },
                  "id": "8c505fde-bcd3-425a-8122-db8abf488224"
              }],
              "actions": {
                  "click": "follow-link",
                  "link": "",
                  "open_link_in_new_window": false
              },
              "x_image_background": 26.3561320754717,
              "y_image_background": 13.125,
              "points": [{
                  "x": 83.1615120274914,
                  "y": 100
              }, {
                  "x": 84.07789232531503,
                  "y": 91.32075471698114
              }, {
                  "x": 91.17983963344791,
                  "y": 87.16981132075472
              }, {
                  "x": 100,
                  "y": 84.5283018867924
              }, {
                  "x": 78.35051546391753,
                  "y": 64.52830188679245
              }, {
                  "x": 54.982817869415804,
                  "y": 38.867924528301884
              }, {
                  "x": 30.011454753722795,
                  "y": 18.113207547169814
              }, {
                  "x": 11.683848797250857,
                  "y": 0.3773584905660356
              }, {
                  "x": 6.185567010309277,
                  "y": 0
              }, {
                  "x": 0,
                  "y": 6.6037735849056585
              }, {
                  "x": 0.22909507445589455,
                  "y": 18.490566037735856
              }, {
                  "x": 4.581901489117974,
                  "y": 24.15094339622642
              }, {
                  "x": 7.7892325315005655,
                  "y": 26.415094339622634
              }, {
                  "x": 10.309278350515463,
                  "y": 29.056603773584904
              }, {
                  "x": 12.371134020618554,
                  "y": 27.16981132075472
              }, {
                  "x": 13.058419243986252,
                  "y": 30.18867924528302
              }, {
                  "x": 14.432989690721646,
                  "y": 32.45283018867924
              }, {
                  "x": 15.807560137457042,
                  "y": 35.84905660377358
              }, {
                  "x": 21.076746849942726,
                  "y": 38.867924528301884
              }, {
                  "x": 24.513172966781212,
                  "y": 44.15094339622642
              }, {
                  "x": 26.57502863688429,
                  "y": 46.41509433962265
              }, {
                  "x": 29.324169530355082,
                  "y": 47.92452830188679
              }, {
                  "x": 30.240549828178686,
                  "y": 50.943396226415096
              }, {
                  "x": 32.0733104238259,
                  "y": 55.47169811320756
              }, {
                  "x": 33.90607101947308,
                  "y": 54.33962264150944
              }, {
                  "x": 34.13516609392897,
                  "y": 54.71698113207547
              }, {
                  "x": 35.96792668957616,
                  "y": 54.71698113207547
              }, {
                  "x": 38.258877434135165,
                  "y": 57.35849056603774
              }, {
                  "x": 40.549828178694135,
                  "y": 60.75471698113207
              }, {
                  "x": 43.06987399770906,
                  "y": 60.75471698113207
              }, {
                  "x": 45.36082474226803,
                  "y": 64.52830188679245
              }, {
                  "x": 47.65177548682703,
                  "y": 66.41509433962264
              }, {
                  "x": 48.56815578465064,
                  "y": 69.05660377358491
              }, {
                  "x": 50.859106529209605,
                  "y": 68.67924528301886
              }, {
                  "x": 53.6082474226804,
                  "y": 72.83018867924528
              }, {
                  "x": 59.106529209622,
                  "y": 78.8679245283019
              }, {
                  "x": 63.68843069873995,
                  "y": 82.64150943396227
              }, {
                  "x": 70.21764032073314,
                  "y": 92.45283018867926
              }, {
                  "x": 73.31042382588775,
                  "y": 93.58490566037737
              }, {
                  "x": 76.74684994272623,
                  "y": 93.96226415094341
              }, {
                  "x": 77.20504009163804,
                  "y": 98.86792452830188
              }]
          }, {
              "id": "90f36be2-d7e2-4610-9ce5-aba64007451f",
              "title": "E1",
              "type": "poly",
              "x": 45.16509433962264,
              "y": 16.145833333333336,
              "width": 14.386792452830186,
              "height": 20.208333333333336,
              "default_style": {
                  "background_color": "#ff2600",
                  "background_opacity": 0
              },
              "mouseover_style": {
                  "background_color": "#ffffff",
                  "background_opacity": 0.5,
                  "stroke_width": 2
              },
              "tooltip_content": [{
                  "type": "Heading",
                  "text": "E1 Blok",
                  "heading": "h3",
                  "other": {
                      "id": "",
                      "classes": "",
                      "css": ""
                  },
                  "style": {
                      "fontFamily": "sans-serif",
                      "fontSize": 20.8,
                      "lineHeight": "normal",
                      "color": "#ffffff",
                      "textAlign": "left"
                  },
                  "boxModel": {
                      "width": "auto",
                      "height": "auto",
                      "margin": {
                          "top": 0,
                          "bottom": 0,
                          "left": 0,
                          "right": 0
                      },
                      "padding": {
                          "top": 10,
                          "bottom": 10,
                          "left": 10,
                          "right": 10
                      }
                  },
                  "id": "df6ad09b-541e-44b7-9bcf-ee6cd9a27eee"
              }],
              "actions": {
                  "click": "follow-link",
                  "link": "",
                  "open_link_in_new_window": false
              },
              "x_image_background": 45.22405660377358,
              "y_image_background": 16.354166666666668,
              "points": [{
                  "x": 100,
                  "y": 55.154639175257735
              }, {
                  "x": 86.88524590163937,
                  "y": 45.8762886597938
              }, {
                  "x": 71.72131147540986,
                  "y": 34.020618556701024
              }, {
                  "x": 57.78688524590165,
                  "y": 24.226804123711332
              }, {
                  "x": 42.622950819672155,
                  "y": 14.432989690721637
              }, {
                  "x": 29.50819672131147,
                  "y": 7.216494845360819
              }, {
                  "x": 22.131147540983605,
                  "y": 2.061855670103081
              }, {
                  "x": 11.680327868852444,
                  "y": 0
              }, {
                  "x": 0,
                  "y": 7.474226804123699
              }, {
                  "x": 0.8196721311475244,
                  "y": 32.47422680412371
              }, {
                  "x": 15.983606557377023,
                  "y": 42.26804123711339
              }, {
                  "x": 30.737704918032804,
                  "y": 53.6082474226804
              }, {
                  "x": 45.49180327868854,
                  "y": 65.97938144329893
              }, {
                  "x": 57.78688524590165,
                  "y": 75.25773195876289
              }, {
                  "x": 72.54098360655739,
                  "y": 87.62886597938144
              }, {
                  "x": 88.52459016393442,
                  "y": 100
              }, {
                  "x": 87.76326913387135,
                  "y": 65.66345753027137
              }]
          }, {
              "id": "094f4c42-44bb-4bcc-9eae-6dce49942e9f",
              "title": "E2",
              "type": "poly",
              "x": 57.7425369279884,
              "y": 26.979166666666668,
              "width": 12.717368732388962,
              "height": 21.666666666666668,
              "default_style": {
                  "background_color": "#ff2600",
                  "background_opacity": 0
              },
              "mouseover_style": {
                  "background_color": "#ffffff",
                  "background_opacity": 0.5,
                  "stroke_width": 2
              },
              "tooltip_content": [{
                  "type": "Heading",
                  "text": "E2 Blok",
                  "heading": "h3",
                  "other": {
                      "id": "",
                      "classes": "",
                      "css": ""
                  },
                  "style": {
                      "fontFamily": "sans-serif",
                      "fontSize": 20.8,
                      "lineHeight": "normal",
                      "color": "#ffffff",
                      "textAlign": "left"
                  },
                  "boxModel": {
                      "width": "auto",
                      "height": "auto",
                      "margin": {
                          "top": 0,
                          "bottom": 0,
                          "left": 0,
                          "right": 0
                      },
                      "padding": {
                          "top": 10,
                          "bottom": 10,
                          "left": 10,
                          "right": 10
                      }
                  },
                  "id": "9e35ebf4-05cf-4045-ab9f-e8b2350ac064"
              }],
              "actions": {
                  "click": "follow-link",
                  "link": "",
                  "open_link_in_new_window": false
              },
              "x_image_background": 59.66981132075472,
              "y_image_background": 29.791666666666668,
              "points": [{
                  "x": 88.87274270802075,
                  "y": 100
              }, {
                  "x": 88.40910698752155,
                  "y": 68.26923076923077
              }, {
                  "x": 96.29091423600687,
                  "y": 58.17307692307693
              }, {
                  "x": 100,
                  "y": 56.730769230769226
              }, {
                  "x": 78.67275685703974,
                  "y": 42.307692307692314
              }, {
                  "x": 62.44550663956991,
                  "y": 32.692307692307686
              }, {
                  "x": 49.00007074509503,
                  "y": 23.076923076923077
              }, {
                  "x": 34.62736340962183,
                  "y": 12.019230769230774
              }, {
                  "x": 14.459209567909467,
                  "y": 0
              }, {
                  "x": 0.08650223243621127,
                  "y": 12.980769230769246
              }, {
                  "x": 0,
                  "y": 42.14846856040499
              }, {
                  "x": 16.08193458965638,
                  "y": 51.442307692307686
              }, {
                  "x": 32.30918480712614,
                  "y": 62.5
              }, {
                  "x": 51.31824934759077,
                  "y": 75.00000000000004
              }, {
                  "x": 67.54549956506047,
                  "y": 86.53846153846155
              }]
          }, {
              "id": "42a5573c-728e-4e89-9f17-6070b18ba671",
              "title": "F1",
              "type": "poly",
              "x": 68.77948113207547,
              "y": 39.27083333333333,
              "width": 11.173349056603769,
              "height": 18.645833333333336,
              "default_style": {
                  "background_color": "#ff2600",
                  "background_opacity": 0
              },
              "mouseover_style": {
                  "background_color": "#ffffff",
                  "background_opacity": 0.5,
                  "stroke_width": 2
              },
              "tooltip_content": [{
                  "type": "Heading",
                  "text": "F1 Blok",
                  "heading": "h3",
                  "other": {
                      "id": "",
                      "classes": "",
                      "css": ""
                  },
                  "style": {
                      "fontFamily": "sans-serif",
                      "fontSize": 20.8,
                      "lineHeight": "normal",
                      "color": "#ffffff",
                      "textAlign": "left"
                  },
                  "boxModel": {
                      "width": "auto",
                      "height": "auto",
                      "margin": {
                          "top": 0,
                          "bottom": 0,
                          "left": 0,
                          "right": 0
                      },
                      "padding": {
                          "top": 10,
                          "bottom": 10,
                          "left": 10,
                          "right": 10
                      }
                  },
                  "id": "ac8f8f2c-f22c-4eb4-9e2b-38e30a74330e"
              }],
              "actions": {
                  "click": "follow-link",
                  "link":  "",
                  "open_link_in_new_window": false
              },
              "x_image_background": 68.86792452830188,
              "y_image_background": 39.479166666666664,
              "points": [{
                  "x": 84.16886543535614,
                  "y": 100
              }, {
                  "x": 84.43271767810022,
                  "y": 62.2905027932961
              }, {
                  "x": 92.34828496042215,
                  "y": 53.910614525139664
              }, {
                  "x": 100,
                  "y": 49.162011173184375
              }, {
                  "x": 75.72559366754615,
                  "y": 36.312849162011176
              }, {
                  "x": 51.45118733509231,
                  "y": 20.670391061452538
              }, {
                  "x": 18.20580474934029,
                  "y": 1.1173184357542025
              }, {
                  "x": 11.345646437994718,
                  "y": 0
              }, {
                  "x": 0,
                  "y": 12.849162011173195
              }, {
                  "x": 0,
                  "y": 48.882681564245814
              }, {
                  "x": 29.287598944591046,
                  "y": 67.0391061452514
              }, {
                  "x": 57.25593667546177,
                  "y": 83.79888268156427
              }]
          }, {
              "id": "006a2a3a-3d4c-47a3-b1c6-edc3883fb5da",
              "title": "F2",
              "type": "poly",
              "x": 78.18396226415094,
              "y": 48.541666666666664,
              "width": 12.32311320754718,
              "height": 18.020833333333336,
              "default_style": {
                  "background_color": "#ff2600",
                  "background_opacity": 0
              },
              "mouseover_style": {
                  "background_color": "#ffffff",
                  "background_opacity": 0.5,
                  "stroke_width": 2
              },
              "tooltip_content": [{
                  "type": "Heading",
                  "text": "F2 Blok",
                  "heading": "h3",
                  "other": {
                      "id": "",
                      "classes": "",
                      "css": ""
                  },
                  "style": {
                      "fontFamily": "sans-serif",
                      "fontSize": 20.8,
                      "lineHeight": "normal",
                      "color": "#ffffff",
                      "textAlign": "left"
                  },
                  "boxModel": {
                      "width": "auto",
                      "height": "auto",
                      "margin": {
                          "top": 0,
                          "bottom": 0,
                          "left": 0,
                          "right": 0
                      },
                      "padding": {
                          "top": 10,
                          "bottom": 10,
                          "left": 10,
                          "right": 10
                      }
                  },
                  "id": "efd606dd-1e78-4ee2-ad3c-46e6937d7f53"
              }],
              "actions": {
                  "click": "follow-link",
                  "link":  "",
                  "open_link_in_new_window": false
              },
              "x_image_background": 78.18396226415094,
              "y_image_background": 48.541666666666664,
              "points": [{
                  "x": 99.04306220095695,
                  "y": 100
              }, {
                  "x": 100,
                  "y": 61.84971098265897
              }, {
                  "x": 100,
                  "y": 41.04046242774567
              }, {
                  "x": 90.90909090909093,
                  "y": 35.83815028901735
              }, {
                  "x": 65.07177033492823,
                  "y": 24.855491329479754
              }, {
                  "x": 42.58373205741622,
                  "y": 15.028901734104059
              }, {
                  "x": 17.703349282296678,
                  "y": 0
              }, {
                  "x": 12.440191387559773,
                  "y": 0.5780346820809117
              }, {
                  "x": 0.4784688995215785,
                  "y": 12.716763005780333
              }, {
                  "x": 0,
                  "y": 50.867052023121374
              }, {
                  "x": 23.923444976076507,
                  "y": 65.89595375722543
              }, {
                  "x": 47.84688995215313,
                  "y": 78.03468208092484
              }, {
                  "x": 73.68421052631582,
                  "y": 89.59537572254335
              }]
          }, {
              "id": "66a301b7-0fc3-46d0-a84a-4d381900fa7d",
              "title": "G",
              "type": "poly",
              "x": 32.76886622590839,
              "y": 3.75554084777832,
              "width": 12.296226415094338,
              "height": 14.014166666666664,
              "default_style": {
                  "background_color": "#b51a00",
                  "background_opacity": 0.3,
                  "stroke_color": "#b51a00",
                  "stroke_width": 2
              },
              "mouseover_style": {
                  "background_color": "#ffb5af",
                  "background_opacity": 0.5,
                  "stroke_opacity": 1,
                  "stroke_width": 2
              },
              "tooltip_content": [{
                  "type": "Heading",
                  "text": "G Blok",
                  "heading": "h3",
                  "other": {
                      "id": "",
                      "classes": "",
                      "css": ""
                  },
                  "style": {
                      "fontFamily": "sans-serif",
                      "fontSize": 20.8,
                      "lineHeight": "normal",
                      "color": "#ffffff",
                      "textAlign": "left"
                  },
                  "boxModel": {
                      "width": "auto",
                      "height": "auto",
                      "margin": {
                          "top": 0,
                          "bottom": 0,
                          "left": 0,
                          "right": 0
                      },
                      "padding": {
                          "top": 10,
                          "bottom": 10,
                          "left": 10,
                          "right": 10
                      }
                  },
                  "id": "6aaf1c93-c29f-4f46-a920-fee731495160"
              }],
              "actions": {
                  "click": "follow-link",
                  "link": "",
                  "open_link_in_new_window": false
              },
              "x_image_background": 32.81886622590839,
              "y_image_background": 3.75554084777832,
              "points": [{
                  "x": 79.15643701089456,
                  "y": 94.88315395135874
              }, {
                  "x": 80.48565290777961,
                  "y": 80.27591128025212
              }, {
                  "x": 99.90601503759399,
                  "y": 70.2414223702206
              }, {
                  "x": 100,
                  "y": 38.73758696557054
              }, {
                  "x": 96.54940923737918,
                  "y": 36.4214782660403
              }, {
                  "x": 96.54940923737918,
                  "y": 24.9003984063745
              }, {
                  "x": 71.9061684824305,
                  "y": 13.724207647023839
              }, {
                  "x": 55.76925195763693,
                  "y": 8.847316679377323
              }, {
                  "x": 51.70895833517957,
                  "y": 18.81974265413135
              }, {
                  "x": 47.44535030425194,
                  "y": 8.24153534114081
              }, {
                  "x": 36.35976986245045,
                  "y": 7.959763338286807
              }, {
                  "x": 34.32128363911069,
                  "y": 6.63968472302435
              }, {
                  "x": 33.711146945221024,
                  "y": 2.574316433871683
              }, {
                  "x": 29.65705079024087,
                  "y": 0
              }, {
                  "x": 0,
                  "y": 13.750966284117258
              }, {
                  "x": 1.3107493538088306,
                  "y": 15.398478339093385
              }, {
                  "x": 1.365659045573074,
                  "y": 31.218409942320264
              }, {
                  "x": 1.5922027898813793,
                  "y": 63.87675782698381
              }, {
                  "x": 1.845174159889525,
                  "y": 66.89659273354344
              }, {
                  "x": 11.675234003375794,
                  "y": 71.9272165071059
              }, {
                  "x": 21.07756636489175,
                  "y": 78.04602485580068
              }, {
                  "x": 31.5751112475065,
                  "y": 84.36403639174644
              }, {
                  "x": 36.61001994782872,
                  "y": 88.45216150324077
              }, {
                  "x": 36.84977750498694,
                  "y": 91.05369566510079
              }, {
                  "x": 50.75571582016264,
                  "y": 97.74335493845513
              }, {
                  "x": 60.95596133190123,
                  "y": 100
              }]
          }]
      }],
      "version": "6.0.21"
    };

    // Linkleri baseURL ile güncelleyen fonksiyon
    function updateLinks(settings, baseURL) {
      settings.artboards.forEach((artboard) => {
        artboard.children.forEach((child) => {
          child.actions.link = `${baseURL}/html/consumption-overview.html?block=${child.title}`;
        });
      });
    }

    // Linkleri güncelleyip ImageMapPro'yu başlat
    updateLinks(imageMapProSettings, baseURL);
    ImageMapPro.init('#image-map-pro', imageMapProSettings);
</script>

</body>
</html>
  <script>
    function updateGeneratorStatusChart() {
        fetch(`${baseWebhookURL}/webhook/get-generator-status`, {
            method: "POST",
            headers: {
            "Content-Type": "application/json"
            }
        })
        .then(response => response.json())
    .then(data => {
        if (Array.isArray(data) && data.length > 0) {
            data = data[0]; // Use the first object in the array
        }
        console.log("Jeneratör durum verisi:", data);
        let recentChanges = [];
        if (data.recentStatusChanges) {
            try {
                recentChanges = JSON.parse(data.recentStatusChanges);
            } catch (e) {
                console.error("recentStatusChanges JSON parse error:", e);
            }
        }
        let lastKnownStatus = false;
        let lastChangeTime = new Date();

        if (data.lastKnownStatus) {
            try {
                const parsedStatus = JSON.parse(data.lastKnownStatus);
                lastKnownStatus = parsedStatus.IsOnline;
                lastChangeTime = new Date(parsedStatus.StatusChangeTime);
            } catch (e) {
                console.error("lastKnownStatus JSON parse error:", e);
            }
        }
            const now = new Date();
            const fifteenMinutesAgo = new Date(now.getTime() - 15 * 60 * 1000);

            let statusData = [];
            let currentTime = new Date(fifteenMinutesAgo);
            while (currentTime <= now) {
            statusData.push({
                time: new Date(currentTime),
                value: lastKnownStatus
            });
            currentTime.setMinutes(currentTime.getMinutes() + 1);
            }

            // Geçmiş değişiklikleri uygula
            if (Array.isArray(recentChanges)) {
                // Önce zaman sırasına göre sırala
                recentChanges.sort((a, b) => new Date(a.StatusChangeTime) - new Date(b.StatusChangeTime));
                recentChanges.forEach(change => {
                    const changeTime = new Date(change.StatusChangeTime);
                    if (changeTime <= now) {
                        statusData.forEach(entry => {
                            if (entry.time >= changeTime) {
                                entry.value = change.IsOnline;
                            }
                        });
                    }
                });
            }

            const plotData = [{
                x: statusData.map(d => d.time),
                y: statusData.map(d => d.value ? 1 : 0),
                type: 'scatter',
                mode: 'lines',
                line: { shape: 'hv', color: 'rgb(53,158,251)' },
                fill: 'tozeroy',
                fillcolor: 'rgba(53,158,251,0.2)',
            }];

            const layout = {
                margin: { l: 10, r: 10, t: 10, b: 10 },
                yaxis: {
                    title: '',
                    tickvals: [0, 1],
                    ticktext: ["Devre Dışı", "Devrede"],
                    range: [-0.5, 1.5],
                    automargin: true
                },
                xaxis: {
                    type: 'date',
                    tickformat: "%H:%M",
                    automargin: true,
                    showgrid: false
                }
            };

            Plotly.newPlot('generator-status-chart', plotData, layout, { responsive: true, displayModeBar: false });
        })
        .catch(error => {
            console.error("Jeneratör durumu alınamadı:", error);
        });
    }

</script>
<script>
function scheduleGraphGunUpdate() {
    updateGeneratorStatusChart(); // immediately fetch and draw the chart

    const now = new Date();
    const delay = 60000 - (now.getSeconds() * 1000 + now.getMilliseconds());

    setTimeout(() => {
        updateGeneratorStatusChart(); // initial call at next minute mark
        setInterval(updateGeneratorStatusChart, 60000); // then every minute
    }, delay);
}

document.addEventListener("DOMContentLoaded", () => {
    scheduleGraphGunUpdate(); // replaces or complements existing update mechanism
});

document.addEventListener('DOMContentLoaded', () => {
  $('#generatorEventsModal').on('shown.bs.modal', function () {
        fetch(`${baseWebhookURL}/webhook/get-generator-event-history`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            }
        })
        .then(response => response.json())
        .then(responseData => {
            const data = responseData[0]?.data || [];
    
            const tableBody = document.querySelector("#generatorEventsTable tbody");
            if (!tableBody) return;
    
            tableBody.innerHTML = ""; // Clear previous rows
    
            data.forEach((event, index) => {
                const formatDateTime = (isoString) => {
                    const d = new Date(new Date(isoString).getTime() - 3 * 60 * 60 * 1000);
                    return `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')} ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}:${d.getSeconds().toString().padStart(2, '0')}.000`;
                };
                const startTime = formatDateTime(event.StartTime);
                const endTime = event.EndTime ? formatDateTime(event.EndTime) : "-";
                const duration = event.EndTime 
                      ? calculateDuration(event.StartTime, event.EndTime)
                      : new Date() - new Date(event.StartTime) > 0 
                          ? calculateDuration(event.StartTime, new Date())
                          : "-";

                  const row = `
                      <tr>
                          <td>${index + 1}</td>
                          <td>${startTime}</td>
                          <td>${endTime}</td>
                          <td>${event.EndTime ? duration : 'Şu anda aktif'}</td>
                          <td>${event.EndTime ? '<button class="btn btn-sm btn-info btn-energy-detail" data-toggle="modal" data-target="#generatorEnergyModal">Detay</button>' : ''}</td>
                      </tr>
                  `;
                  tableBody.insertAdjacentHTML('beforeend', row);
              });
              $('#generatorEventsTable').DataTable({
                    dom: 'rt<"bottom"B>',
                    paging: false,
                    autoWidth: false,
                    buttons: [
                        {
                        extend: 'excelHtml5',
                        text: 'Excel Olarak İndir',
                        title: 'Jeneratör Olay Geçmişi',
                        filename: 'jenerator_olay_gecmisi'
                        }
                    ],
                    destroy: true
                });
          })
          .catch(error => {
              console.error("Veri çekme hatası:", error);
          });
  });
});

function calculateDuration(start, end) {
    const diffMs = new Date(end) - new Date(start);
    const minutes = Math.floor(diffMs / 60000);
    const hours = Math.floor(minutes / 60);
    const remainingMinutes = minutes % 60;
    return `${hours} saat ${remainingMinutes} dakika`;
}

    $(document).on('click', '.btn-energy-detail', function () {
        const row = $(this).closest("tr");
        const startTime = row.find("td:nth-child(2)").text(); // Devreye Giriş zamanı
        const endTime = row.find("td:nth-child(3)").text(); // Devreden Çıkış zamanı

    fetch(`${baseWebhookURL}/webhook/get-generator-energy-detail`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            startTime: startTime,
            endTime: endTime !== "-" ? endTime : null
        })
    })
    .then(response => response.json())
    .then(result => {
        const meterData = result[0]?.data || [];
        const tbody = document.querySelector("#generatorEnergyTable tbody");
        tbody.innerHTML = "";

        const formatDateTime = (isoString) => {
            const d = new Date(new Date(isoString).getTime() - 3 * 60 * 60 * 1000);
            return `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')} ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}:${d.getSeconds().toString().padStart(2, '0')}.000`;
        };

        const durationText = (start, end) => {
            if (!start) return "-";
            const startTime = new Date(start);
            const endTime = end ? new Date(end) : new Date();
            const diff = endTime - startTime;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const remainingMinutes = minutes % 60;
            return `${hours} saat ${remainingMinutes} dakika`;
        };

        meterData.forEach(item => {
            const row = document.createElement("tr");

            const energyUsed = (item.EndMeterValue != null && item.StartMeterValue != null)
                ? (item.EndMeterValue - item.StartMeterValue).toFixed(2)
                : "-";

            const duration = durationText(item.StartTime, item.EndTime);

            row.innerHTML = `
                <td>${item.SerialNumber || "-"}</td>
                <td>${item.Block || "-"}</td>
                <td>${item.BuildingNo || "-"}</td>
                <td>${item.Flat || "-"}</td>
                <td>${item.Subscriber || "-"}</td>
                <td>${item.StartTime ? formatDateTime(item.StartTime) : "-"}</td>
                <td>${item.StartMeterValue ?? "-"}</td>
                <td>${item.EndTime ? formatDateTime(item.EndTime) : "-"}</td>
                <td>${item.EndMeterValue ?? "-"}</td>
                <td>${energyUsed}</td>
                <td>${duration}</td>
            `;

            tbody.appendChild(row);
        });
        const startTime = StartTime?.replace(/[: ]/g, '-');
        $('#generatorEnergyTable').DataTable({
            dom: 'rt<"bottom"B>',
            paging: false,
            autoWidth: false,
            buttons: [
                {
                extend: 'excelHtml5',
                text: 'Excel Olarak İndir',
                title: 'Jeneratör Enerji Tüketimi Detayları',
                filename: 'jenerator_enerji_tuketim_detayı_${startTime}'
                }
            ],
            destroy: true
        });
        $('#generatorEnergyModal').modal('show');
    })
    .catch(error => {
        console.error("Enerji detayı alınamadı:", error);
    });
});
</script>
  <!-- Generator Events Modal -->
  <div class="modal fade" id="generatorEventsModal" tabindex="-1" role="dialog" aria-labelledby="generatorEventsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="generatorEventsModalLabel">Geçmiş Jeneratör Olayları</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
            <table id="generatorEventsTable" class="table table-striped table-bordered">
            <thead>
              <tr>
                <th>#</th>
                <th>Devreye Giriş</th>
                <th>Devreden Çıkış</th>
                <th>Toplam Süre</th>
                <th>İşlem</th>
              </tr>
            </thead>
            <tbody>
                <!-- İçerik buraya eklenecek -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <!-- Generator Energy Modal -->
  <div class="modal fade" id="generatorEnergyModal" tabindex="-1" role="dialog" aria-labelledby="generatorEnergyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="generatorEnergyModalLabel">Jeneratör Enerji Detayı</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <table id="generatorEnergyTable" class="table table-striped">
            <thead>
                <tr>
                    <th>Seri Numarası</th>
                    <th>Blok</th>
                    <th>Bina No</th>
                    <th>Daire</th>
                    <th>Abone</th>
                    <th>Devreye Girdiği Zaman</th>
                    <th>Girdiği Sayaç Değeri</th>
                    <th>Devreden Çıktığı Zaman</th>
                    <th>Çıktığı Sayaç Değeri</th>
                    <th>Toplam Tüketim</th>
                    <th>Toplam Süre</th>
                </tr>
            </thead>
            <tbody>
                <!-- İçerik buraya eklenecek -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>