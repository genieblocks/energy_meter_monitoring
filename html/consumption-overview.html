<!DOCTYPE html>
<html class="loading" lang="en" data-textdirection="ltr">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
  <meta name="description" content="GenieBlocks Cloud Platform is flexable IoT platform that manage your devices.">
  <meta name="keywords" content="GenieBlocks, IoT Platform, cloud, IoT device, edge device, ota, secure, aiot">
  <meta name="author" content="GenieBlocks">
  <title>GenieBlocks Cloud Platform</title>
  <link rel="apple-touch-icon" href="../app-assets/images/ico/apple-icon-120.png">
  <link rel="shortcut icon" type="image/x-icon" href="../app-assets/images/ico/favicon.ico">
  <link
    href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i%7CMuli:300,400,500,700"
    rel="stylesheet">
  <!-- BEGIN VENDOR CSS-->
  <link rel="stylesheet" type="text/css" href="../app-assets/css/bootstrap.css">
  <link rel="stylesheet" type="text/css" href="../app-assets/vendors/css/forms/selects/selectivity-full.min.css">
  <!-- font icons-->
  <link rel="stylesheet" type="text/css" href="../app-assets/fonts/icomoon.css">
  <!-- <link rel="stylesheet" type="text/css" href="../app-assets/fonts/flag-icon-css/css/flag-icon.min.css"> -->
  <!-- <link rel="stylesheet" type="text/css" href="../app-assets/vendors/css/sliders/slick/slick.css"> -->
  <!-- <link rel="stylesheet" type="text/css" href="../app-assets/vendors/css/extensions/pace.css"> -->
  <link rel="stylesheet" type="text/css" href="../app-assets/fonts/feather/style.min.css">
  <link rel="stylesheet" type="text/css" href="../app-assets/fonts/font-awesome/css/font-awesome.min.css">

  <!-- END VENDOR CSS-->
  <!-- BEGIN TEMPLATE CSS-->
  <link rel="stylesheet" type="text/css" href="../app-assets/css/bootstrap-extended.css">
  <link rel="stylesheet" type="text/css" href="../app-assets/css/app.css">
  <link rel="stylesheet" type="text/css" href="../app-assets/css/colors.css">
  <link rel="stylesheet" type="text/css" href="../app-assets/css/components.css">
  <!-- END TEMPLATE CSS-->
  <!-- BEGIN Page Level CSS-->
  <link rel="stylesheet" type="text/css" href="../app-assets/css/core/menu/menu-types/vertical-menu.css">
  <link rel="stylesheet" type="text/css" href="../app-assets/css/core/colors/palette-gradient.css">
  <link rel="stylesheet" type="text/css" href="../app-assets/css/plugins/forms/selectivity/selectivity.css">
  <!-- END Page Level CSS-->
  <!-- BEGIN Custom CSS-->
  <link rel="stylesheet" type="text/css" href="../assets/css/style.css">
  <!-- END Custom CSS-->
  <style>
    body .modal-dialog { /* Width */
        max-width: 100%;
        width: auto !important;
        display: inline-block;
    }

  </style>

</head>

<body class="vertical-layout vertical-menu 2-columns menu-collapsed" data-open="click" data-menu="vertical-menu"
  data-col="2-columns">

  <!-- ////////////////////////////////////////////////////////////////////////////-->


  <div class="main-menu menu-fixed menu-dark menu-accordion menu-shadow" data-scroll-to-active="true">
    <div class="main-menu-content">
      <ul class="navigation navigation-main" id="main-menu-navigation" data-menu="menu-navigation">
        <li class="nav-item"><a style="padding-left: 9px" href="#">
            <img class="brand-logo" alt="GenieBlocks logo" src="../app-assets/images/logo/logo-light-sm.png">
            <span class="mt-1" data-i18n="">
              <h3 class="brand-text"><span class="white">&nbsp;&nbsp;&nbsp;&nbsp;Genie</span><span
                  class="font-weight-bold blue accent-4">Blocks</span></h3>
            </span>
          </a>
        </li>
        <!-- <div class="main-menu-header">
          <input type="text" placeholder="Mesken Ara" class="menu-search form-control round"/>
        </div> -->
        <li class="nav-item"><a href="dashboard.html"><i class="icon-home3"></i><span class="menu-title"
          data-i18n="">Durum Panosu</span></a>
        </li>
        <li class="nav-item open"><a href="#"><i class="icon-stats-dots"></i><span class="menu-title" data-i18n="">Tüketim İzleme</span></a>
          <ul class="menu-content">
            <!-- JavaScript ile dinamik olarak eklenecek blok menüleri için boş bırakıldı -->
          </ul>
        </li>
        <li class="nav-item"><a href="consumption-reports.html"><i class="fa fa-clipboard"></i><span class="menu-title"
          data-i18n="">Tüketim Raporları</span></a>
        </li>
        <li class="nav-item"><a href="devices-device-list.html"><i class="icon-sliders"></i><span class="menu-title"
          data-i18n="">Sayaç Yönetimi</span></a>
        </li>
      </ul>
    </div>
  </div>

  <div class="app-content content bg-white">
    <div class="content-body">
      <nav
        class="header-navbar navbar-expand-md navbar navbar-with-menu navbar-light navbar-border navbar-brand-center">
        <div class="navbar-wrapper">
          <div class="navbar-header">
            <ul class="nav navbar-nav flex-row">
              <li class="nav-item mobile-menu d-md-none mr-auto"><a
                  class="nav-link nav-menu-main menu-toggle hidden-xs is-active" href="#"><i
                    class="ft-menu font-large-1"></i></a></li>
              <li class="nav-item d-md-none"><a class="navbar-brand" href="#"><img class="brand-logo"
                    alt="genieblocks logo" src="../app-assets/images/logo/logo-light-sm.png">
                </a></li>
              <li class="nav-item d-md-none"><a class="nav-link open-navbar-container collapsed" data-toggle="collapse"
                  data-target="#navbar-mobile" aria-expanded="false"><i class="fa fa-ellipsis-v"></i></a></li>
            </ul>
          </div>
          <div class="navbar-container content">
            <div class="collapse navbar-collapse" id="navbar-mobile">
              <ul class="nav navbar-nav mr-auto float-left">
                <li class="nav-item d-none d-md-block"><a class="nav-link nav-menu-main menu-toggle hidden-xs"
                    href="#"><i class="ft-menu"></i></a>
                </li>
                <li class="nav-item"><a class="nav-link" href="#" role="button" aria-haspopup="true"
                  aria-expanded="false">Tüketim İzleme</a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </nav>
      <div class="content-wrapper">
        <!-- Block and Subscriber Details Section Start -->
        <section id="block-subscriber-details">
          <div class="row">
            <div class="col-xs-12 col-md-12">
              <div class="card border-genie">
                <div class="card-header">
                  <h4 class="card-title" id="block-title"></h4> <!-- Dinamik Başlık eklenecek -->
                  <a class="heading-elements-toggle"><i class="icon-ellipsis font-medium-3"></i></a>
                  <div class="heading-elements">
                    <ul class="list-inline mb-0">
                      <li><a data-action="expand"><i class="icon-expand2"></i></a></li>
                    </ul>
                  </div>
                </div>
                <div class="card-body">
                  <div class="card-block">
                    <table class="table table-hover table-bordered" id="block-detail-table">
                      <thead>
                        <tr>
                          <th class="d-none">Sıra No</th>
                          <th>Bina No</th>
                          <th>Daire</th>
                          <th class="d-none">FlatID</th>
                          <th>Abone</th>
                          <th class="d-none">Not</th>
                          <th class="d-none">Elektrik Tük. (kWh)</th>
                          <th class="d-none">Su Tük. (Soğuk) (m3)</th>
                          <th class="d-none">Su Tük. (Sıcak) (m3)</th>
                          <th class="d-none">Kalori. Sıcak Tük. (kWh)</th>
                          <th class="d-none">Kalori. Soğuk Tük. (kWh)</th>
                          <th>Detay</th>
                        </tr>
                      </thead>
                      <tbody>
                        <!-- Dinamik içerik buraya eklenecek -->
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
        <!-- Block and Subscriber Details Section End -->
      </div>
    </div>
  </div>

<!-- Add Modal Flat Details-->
<div class="modal fade" id="meter-detail-modal" tabindex="-1" role="dialog" aria-labelledby="meter-detail-modalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="meter-detail-modalLabel"></h5>
        <div class="heading-elements">
          <button type="button" id="updateSubscriberButton" class="btn btn-sm btn-genie me-2">Abone Güncelle</button>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
      </div>
      <div class="modal-body">
        <table class="table table-hover table-bordered" id="defined-meters-table">
          <thead>
            <tr>
              <th>Sayaç Tipi</th>
              <th>Sayaç İsmi</th>
              <th>Seri Numarası</th>
              <th>Sayaç Çarpanı</th>
              <th>Sayaç Değeri</th>
              <th>Okuma Zamanı</th>
              <th class="d-none">TableName</th>
              <th class="d-none">MeterIDFieldName</th>
              <th class="d-none">MeterID</th>
              <th class="d-none">RelatedID</th>
              <th class="d-none">Not</th>
              <th class="d-none">Faturalandırma</th>
              <th>Anlık Okuma</th>
              <th>Düzenle</th>
            </tr>
          </thead>
          <tbody id="detailTableBody">
            <!-- Dinamik olarak doldurulacak -->
          </tbody>
        </table>
        <div class="form-group">
          <button id="defineMeterButton" class="btn btn-info btn-lg" data-toggle="modal" data-target="#addRowModalMeter">
            Sayaç Tanımla
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Single Query Modal -->
<div class="modal fade text-left" id="singleQueryModal" tabindex="-1" role="dialog" aria-labelledby="singleQueryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title text-bold-600" id="singleQueryModalLabel"></h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <table class="table table-hover table-bordered zero-configuration dataTable w-auto" id="singleQueryDataTable" role="grid">
            <thead>
                <tr>
                  <th>Seri Numarası</th>
                  <th>Bağlantı Noktası</th>
                  <th>Seri Port</th>
                  <th>Üretici Kodu</th>
                  <th>Değeri</th>
                </tr>
            </thead>
            <tbody>
                <!-- Dinamik içerik buraya eklenecek -->
            </tbody>
        </table>
        <div id="no-content-message-query" class="alert alert-warning" style="display: none;">Cihaza Erişilemedi.
        </div>
      </div>
      <div class="modal-footer">
          <input type="reset" class="btn btn-light" data-dismiss="modal" value="Kapat">
      </div>
    </div>
  </div>
</div>

<!-- Single IEC Query Modal -->
<div class="modal fade text-left" id="singleIecQueryModal" tabindex="-1" role="dialog" aria-labelledby="singleIecQueryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title text-bold-600" id="singleIecQueryModalLabel"></h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <table class="table table-hover table-bordered zero-configuration dataTable w-auto" id="singleIecQueryDataTable" role="grid">
            <thead>
                <tr>
                  <th>OBIS Kodu</th>
                  <th>Açıklama</th>
                  <th>Değer</th>
                </tr>
            </thead>
            <tbody>
                <!-- Dinamik içerik buraya eklenecek -->
            </tbody>
        </table>
        <div id="no-content-message-query" class="alert alert-warning" style="display: none;">Cihaza Erişilemedi.
        </div>
      </div>
      <div class="modal-footer">
          <input type="reset" class="btn btn-light" data-dismiss="modal" value="Kapat">
      </div>
    </div>
  </div>
</div>

<!-- Update Data Modal -->
<div class="modal fade text-left" id="updateDataModal" tabindex="-1" role="dialog" aria-labelledby="updateDataModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
      <div class="modal-content">
          <div class="modal-header">
              <h4 class="modal-title text-bold-600" id="updateDataModalLabel">Güncelleme</h4>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
              </button>
          </div>
          <div class="modal-body">
            <form id="updateDataForm">
                <!-- Dinamik form alanları buraya eklenecek -->
            </form>
          </div>
          <div class="modal-footer">
              <input type="reset" class="btn btn-light" data-dismiss="modal" value="Kapat">
              <input type="button" class="btn btn-genie white" value="Güncelle" onclick="updateTableContent()">
          </div>
      </div>
  </div>
</div>

<!-- Define Meter Modal -->
<div class="modal fade text-left" id="defineMeterModal" tabindex="-1" role="dialog" aria-labelledby="defineMeterModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
      <div class="modal-content">
          <div class="modal-header">
              <h4 class="modal-title text-bold-600" id="defineMeterModalLabel">Sayaç Tanımlama</h4>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
              </button>
          </div>
          <div class="modal-body">
            <form id="defineMeterDataForm">
                <select class="undefined-meters-select-input selectivity-input">
                    <!-- Dinamik form alanları buraya eklenecek -->
                </select>
            </form>
          </div>
          <div class="modal-footer">
              <input type="reset" class="btn btn-light" data-dismiss="modal" value="Kapat">
              <input type="button" class="btn btn-genie white" value="Tanımla" onclick="defineMeter()">
          </div>
      </div>
  </div>
</div>

  <!-- ////////////////////////////////////////////////////////////////////////////  -->

  <footer class="footer footer-static footer-light navbar-border">
      <p class="clearfix blue-grey lighten-2 text-sm-center mb-0 px-2">
          <span class="float-md-left d-block d-md-inline-block">
              Copyright &copy; <span id="footer-dynamic-year"></span> <a class="text-bold-800 darken-2"
              href="http://www.genieblocks.com" target="_blank">GenieBlocks</a>, All rights reserved.
          </span>
          <span class="float-md-none d-block d-md-inline-block red">Production</span>
          <span class="float-md-right d-block d-md-inline-block d-none d-lg-block">Made with <i
              class="ft-heart pink"></i></span>
      </p>
  </footer>

  <!-- BEGIN VENDOR JS-->
  <!-- <script src="../app-assets/vendors/js/ui/tether.min.js" type="text/javascript"></script>
  <script src="../app-assets/vendors/js/ui/jquery.matchHeight-min.js" type="text/javascript"></script>
  <script src="../app-assets/vendors/js/sliders/slick/slick.min.js" type="text/javascript"></script>
  <script src="../app-assets/vendors/js/ui/screenfull.min.js" type="text/javascript"></script>
  <script src="../app-assets/vendors/js/extensions/pace.min.js" type="text/javascript"></script> -->
  <!-- BEGIN VENDOR JS-->
  <script src="../app-assets/vendors/js/ui/popper.min.js"></script>

  <script src="../app-assets/js/core/libraries/jquery.min.js"></script>
  <script src="../app-assets/vendors/js/ui/tether.min.js"></script>
  <script src="../app-assets/js/core/libraries/bootstrap.min.js"></script>
  <script src="../app-assets/vendors/js/ui/perfect-scrollbar.jquery.min.js"></script>
  <script src="../app-assets/vendors/js/ui/unison.min.js"></script>
  <script src="../app-assets/vendors/js/ui/blockUI.min.js"></script>
  <script src="../app-assets/vendors/js/ui/jquery.matchHeight-min.js"></script>
  <script src="../app-assets/vendors/js/ui/jquery-sliding-menu.js"></script>
  <script src="../app-assets/vendors/js/sliders/slick/slick.min.js"></script>
  <script src="../app-assets/vendors/js/ui/screenfull.min.js"></script>
  <script src="../app-assets/vendors/js/extensions/pace.min.js"></script>
  <!-- END VENDOR JS-->
  <!-- BEGIN PAGE VENDOR JS-->
  <script src="../app-assets/vendors/js/forms/repeater/jquery.repeater.min.js" ></script>
  <script src="../app-assets/vendors/js/forms/select/selectivity-full.min.js"></script>
  <!-- END PAGE VENDOR JS-->
  <!-- BEGIN TEMPLATE JS-->
  <script src="../app-assets/js/core/app-menu.js"></script>
  <script src="../app-assets/js/core/app.js"></script>
  <!-- END TEMPLATE JS-->
  <!-- BEGIN PAGE LEVEL JS-->
  <script src="../app-assets/js/scripts/forms/form-repeater.js" type="text/javascript"></script>
  <script src="../app-assets/js/scripts/extensions/block-ui.js"></script>
  <script src="../app-assets/js/scripts/modal/components-modal.js"></script>
  <script src="../app-assets/js/scripts/obisDescriptions.js"></script>
  <script src="../app-assets/js/scripts/forms/select/form-selectivity.js"></script>
  <!-- END PAGE LEVEL JS-->
  <script>
  // const baseWebhookURL = "http://127.0.0.1:5678"; // Değiştirmek istediğiniz temel URL
  const baseWebhookURL = "http://192.168.2.250:5678"; // Değiştirmek istediğiniz temel URL
  // const baseWebhookURL = "http://192.168.1.146:5678"; // Değiştirmek istediğiniz temel URL

$(document).ready(function() {
    $('.undefined-meters-select-input').selectivity({
      allowClear: true,
      placeholder: 'Sayaç Seçiniz',
      searchInputPlaceholder: 'Sayaç Ara'
    });
});

// singleQueryModal
function queryMeterData(serialNumber, connectionPoint, meterCategory) {
  const modalId = 'singleQueryModal';
  const tableId = '#singleQueryDataTable';
  const noContentMessageQueryId = 'no-content-message-query';

  // meterCategory'ye göre meterType belirle
  let meterType = '';
  if (meterCategory === "Kalorimetre (Isıtma)") meterType = "heating";
  else if (meterCategory === "Kalorimetre (Soğutma)") meterType = "cooling";
  else if (meterCategory === "Su") meterType = "water";

  resetModal(modalId, tableId, noContentMessageQueryId);

  // Modalı göster ve içerik yüklenirken blokla
  $(`#${modalId}`).modal('show');
  $(`#${modalId} .modal-content`).block({
    message: '<div class="icon-spinner9 icon-spin icon-lg"></div>',
    overlayCSS: { backgroundColor: '#fff', opacity: 0.8, cursor: 'wait' },
    css: { border: 0, padding: 0, backgroundColor: 'transparent' }
  });

  fetch(`${baseWebhookURL}/webhook/query-meter-data`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      serialNumber: serialNumber,
      connectionPoint: connectionPoint,
      meterType: meterType  // meterType gönderiliyor
    })
  })
    .then(response => {
      if (!response.ok) {
        return response.text().then(errText => {
          throw new Error(errText);
        });
      }
      return response.json();
    })
    .then(data => {
      if (Array.isArray(data) && data.length > 0) {
        updateSingleQueryModal(data, modalId, tableId, noContentMessageQueryId);
      } else {
        throw new Error('Cihaza erişilemedi veya veri bulunamadı.');
      }
    })
    .catch(error => {
      displayErrorInModal(modalId, tableId, noContentMessageQueryId, error.message || error);
    })
    .finally(() => {
      $(`#${modalId} .modal-content`).unblock();
    });
}

function resetModal(modalId, tableId, noContentMessageQueryId) {
  const modal = document.getElementById(modalId);
  if (!modal) {
    console.error(`Modal bulunamadı: ID="${modalId}"`);
    return;
  }

  const tableBody = modal.querySelector(`${tableId} tbody`);
  const noContentMessageQuery = modal.querySelector(`#${noContentMessageQueryId}`);

  if (tableBody) {
    tableBody.innerHTML = '';
  }
  if (noContentMessageQuery) {
    noContentMessageQuery.style.display = 'none';
  }
}

function displayErrorInModal(modalId, tableId, noContentMessageQueryId, error) {
  const modal = document.getElementById(modalId);
  if (!modal) {
    console.error(`Modal bulunamadı: ID="${modalId}"`);
    return;
  }

  const tableBody = modal.querySelector(`${tableId} tbody`);
  const noContentMessageQuery = modal.querySelector(`#${noContentMessageQueryId}`);

  if (tableBody) {
    tableBody.innerHTML = '';
  }

  let displayedMessage = 'Bilinmeyen bir hata oluştu.';
  if (typeof error === 'string') {
    try {
      const errorData = JSON.parse(error);
      if (Array.isArray(errorData) && errorData[0]?.error) {
        displayedMessage = errorData[0].error;
      } else {
        displayedMessage = error;
      }
    } catch (e) {
      displayedMessage = error;
    }
  }

  if (noContentMessageQuery) {
    noContentMessageQuery.style.display = 'block';
    noContentMessageQuery.textContent = displayedMessage;
  } else {
    console.error(`Hata mesajı göstermek için gerekli element bulunamadı: ${noContentMessageQueryId}`);
  }
}

function updateSingleQueryModal(data, modalId, tableId, noContentMessageQueryId) {
  const modal = document.getElementById(modalId);
  if (!modal) {
    console.error(`Modal with ID "${modalId}" not found.`);
    return;
  }

  resetModal(modalId, tableId, noContentMessageQueryId);

  const tableBody = modal.querySelector(`${tableId} tbody`);
  const noContentMessageQuery = modal.querySelector(`#${noContentMessageQueryId}`);

  if (data && Array.isArray(data) && data.length > 0) {
    noContentMessageQuery.style.display = 'none';

    data.forEach(item => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${item.device_addr}</td>
        <td>${item.connectionPoint}</td>
        <td>${item.serial_port}</td>
        <td>${item.ManID}</td>
        <td>${item.meterValue}</td>
      `;
      tableBody.appendChild(row);
    });
  } else {
    noContentMessageQuery.style.display = 'block';
    noContentMessageQuery.textContent = 'Cihaza erişilemedi veya veri bulunamadı.';
  }

  $(`#${modalId} .modal-content`).unblock();
}

// Detay modalında "Anlık Okuma" butonu işlevselliği
document.addEventListener('click', function (event) {
  if (event.target && event.target.id === 'table-show-button') {
    const row = event.target.closest('tr');
    if (!row) {
      console.error('Hedef satır bulunamadı.');
      return;
    }

    // Sayaç Tipi, Seri Numarası ve Bağlantı Noktası bilgilerini al
    const meterCategory = row.children[0]?.innerText.trim(); // Sayaç Tipi
    const serialNumber = row.children[2]?.innerText.trim(); // Seri Numarası
    const connectionPoint = row.getAttribute('data-connection-point'); // Bağlantı Noktası

    if (!serialNumber || !connectionPoint) {
      console.error('Seri Numarası veya Bağlantı Noktası bilgisi eksik.');
      return;
    }

    // Sayaç Tipine göre sorgu fonksiyonunu çağır
    if (meterCategory === 'Elektrik') {
      queryIecMeterData(serialNumber, connectionPoint);
    } else {
      queryMeterData(serialNumber, connectionPoint, meterCategory);
    }
  }
});

// singleIecQueryModal
function queryIecMeterData(serialNumber, connectionPoint) {
  const modalId = 'singleIecQueryModal';
  const tableId = '#singleIecQueryDataTable';
  const noContentMessageQueryId = 'no-content-message-query';

  resetModal(modalId, tableId, noContentMessageQueryId);

  // Modalı göster ve içerik yüklenirken blokla
  $(`#${modalId}`).modal('show');
  $(`#${modalId} .modal-content`).block({
    message: '<div class="icon-spinner9 icon-spin icon-lg"></div>',
    overlayCSS: { backgroundColor: '#fff', opacity: 0.8, cursor: 'wait' },
    css: { border: 0, padding: 0, backgroundColor: 'transparent' }
  });

  fetch(`${baseWebhookURL}/webhook/query-iec-meter-data`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ serialNumber: serialNumber, connectionPoint: connectionPoint })
  })
    .then(response => {
      if (!response.ok) {
        return response.text().then(errText => {
          throw new Error(errText); // Hata string olarak dönerse doğrudan fırlat
        });
      }
      return response.json();
    })
    .then(data => {
      if (data && data.length > 0) {
        updateSingleIecQueryModal(data);
      } else {
        console.warn('Cihaza erişim başarısız veya veri bulunamadı.');
        displayErrorInModal(modalId, tableId, noContentMessageQueryId, 'Cihaza erişilemedi veya veri bulunamadı.');
      }
    })
    .catch(error => {
      displayErrorInModal(modalId, tableId, noContentMessageQueryId, error.message || error);
    })
    .finally(() => {
      $(`#${modalId} .modal-content`).unblock();
    });
}

function updateSingleIecQueryModal(data) {
  // Modal açılmadan önce sıfırla
  resetModal('singleIecQueryModal', '#singleIecQueryDataTable', 'no-content-message-query');

  const tableBody = document.querySelector('#singleIecQueryDataTable tbody');
  const noContentMessageQuery = document.getElementById('no-content-message-query');

  if (data && data.length > 0) {
    noContentMessageQuery.style.display = 'none'; // Hata mesajını gizle

    // Identification mesajını ayıkla
    const identificationMsg = data[0].identification_msg || '';
    const versionMatch = identificationMsg.match(/<(\d+)>/);
    const version = versionMatch ? parseInt(versionMatch[1], 10) : null;

    const obisDescriptionsSource = version === 3 ? obisDescriptionsTedas3 : obisDescriptionsTedas;

    // Identification mesajını tabloya ekle
    const identificationRow = document.createElement('tr');
    identificationRow.innerHTML = `
      <td>---</td>
      <td>Haberleşme İstek Mesajı Cevabı</td>
      <td>${identificationMsg}</td>
    `;
    tableBody.appendChild(identificationRow);

    // Sayaç verisini ayrıştır
    const meterData = data[0].data.split('\r\n');
    meterData.forEach((meter) => {
      if (meter) {
        const obisCode = meter.split('(')[0].trim();
        const obisValue = meter.substring(meter.indexOf('(')).trim();
        const obisDescription = obisDescriptionsSource[obisCode] || "Açıklama Bulunamadı.";

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${obisCode || ''}</td>
          <td>${obisDescription || ''}</td>
          <td>${obisValue || ''}</td>
        `;
        tableBody.appendChild(row);
      }
    });
  } else {
    noContentMessageQuery.style.display = 'block'; // Hata mesajını göster
  }
}

// Detay modalını açan ve içeriği dinamik olarak dolduran fonksiyon
function showDetailModal(connection) {
  const detailTableBody = document.getElementById('detailTableBody');
  const definedMetersTable = document.getElementById('defined-meters-table'); // Tablonun elementini seçiyoruz

  // `FlatID` özelliğini `defined-meters-table` tablosuna attribute olarak ekle
  if (definedMetersTable) {
      definedMetersTable.setAttribute('data-flat-id', connection.FlatID ?? '-');
  } else {
      console.error('defined-meters-table bulunamadı.');
  }

  detailTableBody.innerHTML = ''; // Mevcut içeriği temizle

  const flatID = connection.FlatID;
  if (!flatID) {
    console.error("FlatID bulunamadı.");
    return;
  }

  // Tablolar ve sayaç tipleri için ayarları tanımlayın
  const tables = [
    { name: "ElectricMeters", meterCategory: "Elektrik", meterIDFieldName: "ElectricMeterID"},
    { name: "HeatingMeters", meterCategory: "Kalorimetre (Isıtma)", meterIDFieldName: "HeatingMeterID"},
    { name: "CoolingMeters", meterCategory: "Kalorimetre (Soğutma)", meterIDFieldName: "CoolingMeterID"},
    { name: "WaterMeters", meterCategory: "Su", meterIDFieldName: "WaterMeterID"}
  ];

  // Her tablo için veri çek ve tabloya ekle
  tables.forEach(table => {
    fetch(`${baseWebhookURL}/webhook/get-table-row`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        tableName: table.name,
        primaryKey: "RelatedID",
        primaryKeyValue: flatID
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data[0].success && data[0].data) {
        const meterData = data[0].data;

        meterData.forEach(meter => {
          fetch(`${baseWebhookURL}/webhook/get-latest-single-meter-values`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              tableName: table.name,
              SerialNumber: meter.SerialNumber
            })
          })
          .then(response => response.json())
          .then(latestData => {
            if (latestData[0].success && latestData[0].data) {
              const latestValues = latestData[0].data[0];

              const formattedDate = latestValues.QueryStartTime
                ? formatDate(latestValues.QueryStartTime)
                : '-';

              const meterMultiplier = table.meterCategory === "Elektrik" 
                ? (meter.MeterMultiplier ?? '-') 
                : 1;

              const row = document.createElement('tr');
              row.setAttribute('data-connection-point', meter.ConnectionPoint); // connectionPoint saklanıyor

              row.innerHTML = `
                <td>${table.meterCategory}</td>
                <td>${meter.CustomName && meter.CustomName !== 'null' ? meter.CustomName : '-'}</td>
                <td>${meter.SerialNumber && meter.SerialNumber !== 'null' ? meter.SerialNumber : '-'}</td>
                <td>${meterMultiplier}</td>
                <td>${latestValues.MeterValue && latestValues.MeterValue!== 'null' ? latestValues.MeterValue : '-'}</td>
                <td>${formattedDate}</td>
                <td class="d-none">${table.name}</td>
                <td class="d-none">${table.meterIDFieldName}</td>
                <td class="d-none">${meter[table.meterIDFieldName]}</td>
                <td class="d-none">${meter.RelatedID && meter.RelatedID !== 'null' ? meter.RelatedID : '-'}</td>
                <td class="d-none">${meter.Note && meter.Note !== 'null' ? meter.Note : '-'}</td>
                <td class="d-none">${meter.IsVisibleInInvoiceReport}</td>
                <td>
                  <button type="button" class="btn btn-sm btn-outline-info" id="table-show-button">
                    <i class="fa fa-eye"></i>
                  </button>
                </td>
                <td>
                  <span class="dropdown">
                    <button type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="btn btn-genie dropdown-toggle dropdown-menu-right">
                      <i class="ft-settings"></i>
                    </button>
                    <span class="dropdown-menu mt-1 dropdown-menu-right">
                      <button type="button" class="dropdown-item edit-button" id="update-defined-meter-button"><i class="fa fa-pencil"></i> Güncelle</button>
                      <button type="button" class="dropdown-item edit-button" id="remove-defined-meter-button"><i class="fa fa-trash"></i> Kaldır</button>
                    </span>
                  </span>
                </td>
              `;
              detailTableBody.appendChild(row);
            } else {
              console.error('Meter value verisi alınırken bir hata oluştu:', latestData[0].message);
            }
          })
          .catch(error => {
            console.error('Meter value API çağrısında bir hata oluştu:', error);
          });
        });
      } else {
        console.error(`${table.name} verisi alınırken bir hata oluştu:`, data[0].message);
      }
    })
    .catch(error => {
      console.error(`${table.name} verisi çekilirken bir hata oluştu:`, error);
    });
  });

  // Modal başlığı güncelle
  const title = `Bina No: ${connection.BuildingNo ?? '-'} Daire: ${connection.Flat ?? '-'} Abone: ${connection.Subscriber ?? '-'}`;
  document.getElementById('meter-detail-modalLabel').innerText = title;

  // Modalı göster
  $('#meter-detail-modal').modal('show');
}

// Tarih formatı
function formatDate(dateString) {
  const date = new Date(dateString);
  // 3 saat geri çekilerek yeni bir tarih oluşturuluyor
  date.setHours(date.getHours() - 3);
  
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  
  return `${day}.${month}.${year} ${hours}:${minutes}`;
}

// URL'deki "block" parametresini al
const urlParams = new URLSearchParams(window.location.search);
let blockData = []; // Global değişken olarak tanımlayın
const blockParam = urlParams.get('block');
let currentBlock = blockParam || ""; // Başlangıç bloğu URL parametresine göre belirlenir

document.addEventListener('DOMContentLoaded', function () {
    const yearElement = document.getElementById('footer-dynamic-year');
    if (yearElement) {
        const currentYear = new Date().getFullYear();
        yearElement.textContent = currentYear;
    }

    // UI'yi kilitle ve spinner göster
    $.blockUI({
        message: '<div class="icon-spinner9 icon-spin icon-lg"></div>',
        overlayCSS: { backgroundColor: '#fff', opacity: 0.8, cursor: 'wait' },
        css: { border: 0, padding: 0, backgroundColor: 'transparent' },
    });

    // Blok verilerini çek ve tabloya ve menüye ekle
    fetch(`${baseWebhookURL}/webhook/get-table-content`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ tableName: 'Facility' }),
    })
        .then((response) => response.json())
        .then((data) => {
            const blockDetailTableBody = document.querySelector('#block-detail-table tbody');
            blockDetailTableBody.innerHTML = ''; // Mevcut satırları temizle

            if (data[0].success && Array.isArray(data[0].data)) {
                blockData = data[0].data; // blockData'yı global olarak kaydet

                // Benzersiz `Block` değerlerini al, sıralama yap ve menüye ekle
                const uniqueBlocks = [...new Set(data[0].data.map((item) => item.Block))].sort();

                const consumptionMenu = document.querySelector('.menu-content');
                consumptionMenu.innerHTML = ''; // Mevcut menü öğelerini temizle

                uniqueBlocks.forEach((block) => {
                    const menuItem = document.createElement('li');
                    menuItem.className = 'menu-item';
                    menuItem.innerHTML = `<a class="menu-item block-link" href="#" data-block="${block}">Blok ${block}</a>`;
                    consumptionMenu.appendChild(menuItem);
                });

                // En son aktif blok veya URL parametresine göre blok seçimi
                const blockParam = new URLSearchParams(window.location.search).get('block');
                const lastActiveBlock = localStorage.getItem('lastActiveBlock');
                currentBlock = lastActiveBlock || blockParam || uniqueBlocks[0]; // LocalStorage > URL parametresi > İlk blok
                localStorage.setItem('lastActiveBlock', currentBlock); // Aktif blok güncelle
                activateBlock(currentBlock, data[0].data);

                // Tıklanan bloğa göre tabloyu filtrele ve başlığı güncelle
                document.querySelectorAll('.block-link').forEach((link) => {
                    link.addEventListener('click', function (event) {
                        event.preventDefault();
                        const selectedBlock = event.target.getAttribute('data-block');
                        localStorage.setItem('lastActiveBlock', selectedBlock); // Aktif bloğu kaydet
                        activateBlock(selectedBlock, data[0].data);
                    });
                });
            } else {
                console.error('Facility tablosu verileri yüklenemedi:', data[0].message);
            }
        })
        .catch((error) => console.error('Error:', error))
        .finally(() => {
            $.unblockUI(); // UI'yi aç ve spinnerı kaldır
        });
});

// Sayfa değişikliğinde veya başka bir URL'ye yönlendirmede LocalStorage'ı temizle
window.addEventListener('beforeunload', function (event) {
    if (!event.persisted) { // Sayfa cache'lenmemişse
        localStorage.removeItem('lastActiveBlock'); // LocalStorage temizle
    }
});

function activateBlock(block, data) {
    // Sol menüdeki uygun bloğu aktif yap
    document.querySelectorAll('.menu-content .menu-item').forEach((item) => item.classList.remove('active'));
    const blockLink = document.querySelector(`.menu-content .block-link[data-block="${block}"]`);
    if (blockLink) {
        blockLink.parentElement.classList.add('active');
    } else {
        console.warn('Block link not found for:', block); // Debug: Aktivasyon başarısız
    }

    // Blok başlığını güncelle
    const blockTitle = document.getElementById('block-title');
    if (blockTitle) {
        blockTitle.innerText = `Blok ${block}`;
    } else {
        console.error('Block title element not found'); // Debug: Başlık bulunamadı
    }

    // Blok içeriğini güncelle
    updateContent(block, data);
}

  // Bina No ve Daire'ye göre sıralama ve sıra numarası ekleme
  function sortDataAndAddIndex(data) {
    data.sort(customSort); // Veriyi sırala
    data.forEach((item, index) => {
      item.Index = index + 1; // Sıra numarası ekle
    });
    return data;
  }

  // Karışık metin ve sayılar için parçalama fonksiyonu
  function parseMixed(input) {
    const match = input.match(/(\d+|[A-Za-z]+)/g);
    return match ? match.map(part => (isNaN(part) ? part : parseInt(part, 10))) : [];
  }

  // Karışık veri karşılaştırma
  function compareMixed(a, b) {
    const aParts = parseMixed(a);
    const bParts = parseMixed(b);
    for (let i = 0; i < Math.max(aParts.length, bParts.length); i++) {
      if (aParts[i] === undefined) return -1;
      if (bParts[i] === undefined) return 1;
      if (typeof aParts[i] === "number" && typeof bParts[i] === "number") {
        if (aParts[i] !== bParts[i]) return aParts[i] - bParts[i];
      } else if (typeof aParts[i] === "string" && typeof bParts[i] === "string") {
        if (aParts[i] !== bParts[i]) return aParts[i].localeCompare(bParts[i]);
      } else {
        return typeof aParts[i] === "number" ? -1 : 1;
      }
    }
    return 0;
  }

  // Özel sıralama fonksiyonu (Bina No ve Daire'ye göre)
  function customSort(a, b) {
    const buildingComparison = compareMixed(a.BuildingNo, b.BuildingNo);
    if (buildingComparison !== 0) return buildingComparison;
    return compareMixed(a.Flat, b.Flat);
  }

  function updateContent(block, data) {
    const blockDetailTableBody = document.querySelector('#block-detail-table tbody');
    let filteredData = data.filter(connection => connection.Block === block);

    // Sıralama ve sıra numarası ekleme
    filteredData = sortDataAndAddIndex(filteredData);

    blockDetailTableBody.innerHTML = ''; // Tabloyu sıfırla

    filteredData.forEach(connection => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="d-none">${connection.Index ?? '-'}</td> <!-- Sıra Numarası Gizlendi -->
        <td>${connection.BuildingNo ?? '-'}</td>
        <td>${connection.Flat ?? '-'}</td>
        <td class="d-none">${connection.FlatID ?? '-'}</td>
        <td>${connection.Subscriber ?? '-'}</td>
        <td class="d-none">${connection.Note ?? '-'}</td>
        <td class="d-none">${connection.ElectricityUsage ?? '-'}</td>
        <td class="d-none">${connection.HotWaterUsage ?? '-'}</td>
        <td class="d-none">${connection.ColdWaterUsage ?? '-'}</td>
        <td class="d-none">${connection.HeatingUsage ?? '-'}</td>
        <td class="d-none">${connection.CoolingUsage ?? '-'}</td>
        <td>
          <button type="button" class="btn btn-sm btn-outline-info detail-button" id="block-detail-view-button">
            <i class="fa fa-eye"></i>
          </button>
        </td>
      `;
      blockDetailTableBody.appendChild(row);

      // Detay butonu için olay bağlama
      row.querySelector('#block-detail-view-button').addEventListener('click', function(event) {
        event.preventDefault();
        showDetailModal(connection);
      });
    });
  }


document.querySelectorAll('.block-link').forEach(link => {
  link.addEventListener('click', function(event) {
    event.preventDefault();
    const selectedBlock = event.target.getAttribute('data-block');
    updateContent(selectedBlock, data[0].data); // `data` değişkenini uygun veriyle değiştirin
  });
});

// Tek bir genel delegasyon mekanizması
document.addEventListener('click', function(event) {
    const target = event.target;

    // Define Meter Button Clicks
    if (target.id === 'defineMeterButton') {
      event.preventDefault();

      showUndefinedMetersForm();
    }

    // Remove Defined Meter Button Clicks
    if (target.id === 'remove-defined-meter-button') {
      event.preventDefault();

      const tableRow = target.closest('tr');
      if (!tableRow) {
          console.error('Satır bulunamadı.');
          return;
      }

      const table = document.querySelector('#defined-meters-table');
      const headers = Array.from(table.querySelectorAll('thead th'));


      // *************************** SerialNumber *************************** 
      // Tablo başlıklarından "SerialNumber" sütununun indeksini bul
      const serialNumberIndex = headers.findIndex(header => header.textContent.trim() === 'Seri Numarası');

      if (serialNumberIndex === -1) {
          console.error('"SerialNumber" sütunu bulunamadı.');
          return;
      }

      // SerialNumber verisini al
      const serialNumber = tableRow.children[serialNumberIndex]?.textContent.trim();
      if (!serialNumber) {
          console.warn('"SerialNumber" verisi bulunamadı.');
          return;
      }

      // *************************** MeterIDFieldName *************************** 
      // Tablo başlıklarından "MeterIDFieldName" sütununun indeksini bul
      const meterIDFieldNameIndex = headers.findIndex(header => header.textContent.trim() === 'MeterIDFieldName');

      if (meterIDFieldNameIndex === -1) {
          console.error('"MeterIDFieldName" sütunu bulunamadı.');
          return;
      }

      // MeterIDFieldName verisini al
      const meterIDFieldNameData = tableRow.children[meterIDFieldNameIndex]?.textContent.trim();
      if (!meterIDFieldNameData) {
          console.warn('"MeterIDFieldName" verisi bulunamadı.');
          return;
      }

      // *************************** TableName *************************** 
      // Tablo başlıklarından "TableName" sütununun indeksini bul
      const tableNameIndex = headers.findIndex(header => header.textContent.trim() === 'TableName');

      if (tableNameIndex === -1) {
          console.error('"TableName" sütunu bulunamadı.');
          return;
      }

      // TableName verisini al
      const tableName = tableRow.children[tableNameIndex]?.textContent.trim();
      if (!tableName) {
          console.warn('"TableName" verisi bulunamadı.');
          return;
      }

      // *************************** MeterID *************************** 
      // Tablo başlıklarından "MeterID" sütununun indeksini bul
      const meterIDIndex = headers.findIndex(header => header.textContent.trim() === 'MeterID');

      if (meterIDIndex === -1) {
          console.error('"MeterID" sütunu bulunamadı.');
          return;
      }

      // MeterID verisini al
      const meterIDData = tableRow.children[meterIDIndex]?.textContent.trim();
      if (!meterIDData) {
          console.warn('"MeterID" verisi bulunamadı.');
          return;
      }

      if (confirm(`${serialNumber} numaralı sayacı kaldırmak istediğinizden emin misiniz?`)) {
          removeDefinedMeter(tableName, meterIDFieldNameData, meterIDData);
      }
    }

    // Update Defined Meters Button Clicks
    if (target.id === 'update-defined-meter-button') {
        event.preventDefault();

        const tableRow = target.closest('tr');
        if (!tableRow) {
            console.error('Satır bulunamadı.');
            return;
        }

        const table = document.querySelector('#defined-meters-table');
        const headers = Array.from(table.querySelectorAll('thead th'));

        // *************************** SerialNumber *************************** 
        // Tablo başlıklarından "SerialNumber" sütununun indeksini bul
        const serialNumberIndex = headers.findIndex(header => header.textContent.trim() === 'Seri Numarası');

        if (serialNumberIndex === -1) {
            console.error('"SerialNumber" sütunu bulunamadı.');
            return;
        }

        // SerialNumber verisini al
        const serialNumber = tableRow.children[serialNumberIndex]?.textContent.trim();
        if (!serialNumber) {
            console.warn('"SerialNumber" verisi bulunamadı.');
            return;
        }

        // *************************** CustomName *************************** 
        // Tablo başlıklarından "CustomName" sütununun indeksini bul
        const customNameIndex = headers.findIndex(header => header.textContent.trim() === 'Sayaç İsmi');

        if (customNameIndex === -1) {
            console.error('"CustomName" sütunu bulunamadı.');
            return;
        }

        // CustomName verisini al
        const customNameData = tableRow.children[customNameIndex]?.textContent.trim();
        if (!customNameData) {
            console.warn('"CustomName" verisi bulunamadı.');
            return;
        }

        // *************************** Note *************************** 
        // Tablo başlıklarından "Note" sütununun indeksini bul
        const noteIndex = headers.findIndex(header => header.textContent.trim() === 'Not');

        if (noteIndex === -1) {
            console.error('"Note" sütunu bulunamadı.');
            return;
        }

        // Note verisini al
        const noteData = tableRow.children[noteIndex]?.textContent.trim();
        if (!noteData) {
            console.warn('"Note" verisi bulunamadı.');
            return;
        }

        // *************************** IsVisibleInInvoiceReport *************************** 
        // Tablo başlıklarından "IsVisibleInInvoiceReport" sütununun indeksini bul
        const isVisibleInInvoiceReportIndex = headers.findIndex(header => header.textContent.trim() === 'Faturalandırma');

        if (isVisibleInInvoiceReportIndex === -1) {
            console.error('"IsVisibleInInvoiceReport" sütunu bulunamadı.');
            return;
        }

        // IsVisibleInInvoiceReport verisini al
        const isVisibleInInvoiceReportData = tableRow.children[isVisibleInInvoiceReportIndex]?.textContent.trim();
        if (!isVisibleInInvoiceReportData) {
            console.warn('"IsVisibleInInvoiceReport" verisi bulunamadı.');
            return;
        }

        // *************************** MeterIDFieldName *************************** 
        // Tablo başlıklarından "MeterIDFieldName" sütununun indeksini bul
        const meterIDFieldNameIndex = headers.findIndex(header => header.textContent.trim() === 'MeterIDFieldName');

        if (meterIDFieldNameIndex === -1) {
            console.error('"MeterIDFieldName" sütunu bulunamadı.');
            return;
        }

        // MeterIDFieldName verisini al
        const meterIDFieldNameData = tableRow.children[meterIDFieldNameIndex]?.textContent.trim();
        if (!meterIDFieldNameData) {
            console.warn('"MeterIDFieldName" verisi bulunamadı.');
            return;
        }

        // *************************** TableName *************************** 
        // Tablo başlıklarından "TableName" sütununun indeksini bul
        const tableNameIndex = headers.findIndex(header => header.textContent.trim() === 'TableName');

        if (tableNameIndex === -1) {
            console.error('"TableName" sütunu bulunamadı.');
            return;
        }

        // TableName verisini al
        const tableName = tableRow.children[tableNameIndex]?.textContent.trim();
        if (!tableName) {
            console.warn('"TableName" verisi bulunamadı.');
            return;
        }

        // *************************** MeterID *************************** 
        // Tablo başlıklarından "MeterID" sütununun indeksini bul
        const meterIDIndex = headers.findIndex(header => header.textContent.trim() === 'MeterID');

        if (meterIDIndex === -1) {
            console.error('"MeterID" sütunu bulunamadı.');
            return;
        }

        // MeterID verisini al
        const meterIDData = tableRow.children[meterIDIndex]?.textContent.trim();
        if (!meterIDData) {
            console.warn('"MeterID" verisi bulunamadı.');
            return;
        }

        showUpdateDefinedMeterDataForm(tableName, serialNumber, customNameData, noteData, isVisibleInInvoiceReportData, meterIDFieldNameData, meterIDData);
    }

    // Update Subscriber Button Clicks
    if (target.id === 'updateSubscriberButton') {
        event.preventDefault();

        // FlatID'yi `defined-meters-table` attribute'undan al
        const definedMetersTable = document.getElementById('defined-meters-table');
        const flatID = definedMetersTable?.getAttribute('data-flat-id') || null;

        if (!flatID) {
            console.warn('FlatID değeri bulunamadı.');
        }

        // Subscriber verisini modal başlığından al
        const modalTitleElement = document.getElementById('meter-detail-modalLabel');
        const modalTitleText = modalTitleElement?.textContent || '';

        // Subscriber verisini başlık formatına göre ayıkla (örnek: "Bina No: 12 Daire: 3 Abone: John Doe")
        const subscriberMatch = modalTitleText.match(/Abone: (.+)/);
        const subscriberData = subscriberMatch ? subscriberMatch[1].trim() : null;

        if (!subscriberData) {
            console.warn('Subscriber verisi bulunamadı.');
        }

        // Loglama
        console.log('FlatID:', flatID);
        console.log('Subscriber:', subscriberData);

        // Abone Güncelleme Formunu Göster
        showUpdateSubscriberDataForm('Facility', subscriberData, flatID);
    }

});

// Close the dropdown when clicking outside
document.addEventListener('click', function(event) {
  const dropdown = document.querySelector('.dropdown-menu.show');
  if (dropdown && !dropdown.contains(event.target)) {
    dropdown.classList.remove('show');
    dropdown.parentNode.querySelector('.dropdown-toggle').setAttribute('aria-expanded', 'false');
  }
});

// Ensure dropdown is properly hidden after closing
document.querySelectorAll('.dropdown-toggle').forEach(button => {
  button.addEventListener('click', function() {
    setTimeout(() => {
      const dropdown = button.nextElementSibling;
      if (!dropdown.classList.contains('show')) {
        dropdown.style.display = 'none';  // Hide the dropdown completely
      } else {
        dropdown.style.display = '';      // Reset display if dropdown is active
      }
    }, 100); // Small delay to allow dropdown to show before hiding if necessary
  });
});

// Dropdown menüyü tamamen gizle
$(document).on('hide.bs.dropdown', '.dropdown', function (event) {
    $(this).find('.dropdown-menu').css('display', 'none');
});

// Dropdown menüyü açarken görünürlüğünü yeniden ayarla
$(document).on('show.bs.dropdown', '.dropdown', function (event) {
    $(this).find('.dropdown-menu').css('display', '');
});

document.addEventListener('DOMContentLoaded', function() {
  const blockDetailTableBody = document.querySelector('#block-detail-table tbody');

  blockDetailTableBody.addEventListener('click', function(e) {
    if (e.target.classList.contains('icon-cross2')) {
      const row = e.target.closest('tr');
      row.parentNode.removeChild(row);
    }

    if (e.target.classList.contains('icon-save')) {
      const row = e.target.closest('tr');
      const cells = row.querySelectorAll('td');
      cells.forEach(cell => cell.contentEditable = false);
      e.target.classList.remove('icon-save');
      e.target.classList.add('icon-edit');
      e.target.closest('button').classList.remove('btn-success');
      e.target.closest('button').classList.add('btn-warning');
      e.target.closest('button').innerHTML = '<i class="icon-edit"></i> Düzenle';
    }

    if (e.target.classList.contains('icon-edit')) {
      const row = e.target.closest('tr');
      const cells = row.querySelectorAll('td');
      cells.forEach(cell => cell.contentEditable = true);
      e.target.classList.remove('icon-edit');
      e.target.classList.add('icon-save');
      e.target.closest('button').classList.remove('btn-warning');
      e.target.closest('button').classList.add('btn-success');
      e.target.closest('button').innerHTML = '<i class="icon-save"></i> Kaydet';
    }
  });

});

function updateTableContent() {
    const form = document.querySelector('#updateDataForm'); // Form elementini doğru seçin
    if (!form || !(form instanceof HTMLFormElement)) {
        console.error('Form element not found or incorrect type');
        return;
    }

    const formData = new FormData(form);
    const tableName = $('#updateDataModal').data('tableName'); // Modal data attribute'tan tablo ismi alınır
    const targetRecord = {};
    const fieldsToUpdate = {};

    let isFirstField = true;

    formData.forEach((value, key) => {
        if (isFirstField) {
            targetRecord[key] = value; // İlk alan TargetRecord içine alınır
            isFirstField = false;
        } else {
            fieldsToUpdate[key] = value; // Diğer alanlar FieldsToUpdate içine alınır
        }
    });

    const jsonData = {
        tableName: tableName,
        TargetRecord: targetRecord,
        FieldsToUpdate: fieldsToUpdate
    };

    $.blockUI({
        message: '<div class="icon-spinner9 icon-spin icon-lg"></div>',
        overlayCSS: { backgroundColor: '#fff', opacity: 0.8, cursor: 'wait' },
        css: { border: 0, padding: 0, backgroundColor: 'transparent' }
    });

    fetch(`${baseWebhookURL}/webhook/update-table-content`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(jsonData)
    })
    .then(response => response.json())
    .then(data => {
        $.unblockUI();
        if (data[0].success) {
            $('#updateDataModal').modal('hide');
            location.reload(); // Sayfayı yeniden yükle.
        } else {
            alert('Veri güncellenirken bir hata oluştu: ' + data[0].message);
        }
    })
    .catch(error => {
        $.unblockUI();
        alert('Veri güncellenirken bir hata oluştu.');
    });
}

function showUpdateDefinedMeterDataForm(tableName, serialNumber, customNameData, noteData, isVisibleInInvoiceReportData, meterIDFieldNameData, meterIDData) {
    // Modal gösterme işlemleri ve diğer işlevler buraya eklenebilir
    const modal = $('#updateDataModal');

    // Set the tableName as a data attribute on the modal
    modal.data('tableName', tableName);

    modal.find('.modal-title').text(`${serialNumber} Nolu Sayaç Güncelleme`);
    const form = modal.find('form')[0];
    const formBody = modal.find('.modal-body > form')[0];

    // Clear previous form fields
    formBody.innerHTML = '';
        
    // İlk alan TargetRecord --> MeterID
    let formGroup = document.createElement('div');
    formGroup.className = 'form-group';
    formGroup.style.display = 'none'; // Form grubunu gizlemek için
    formGroup.innerHTML = `
        <label for="${meterIDFieldNameData}">${meterIDFieldNameData}</label>
        <input type="text" style="width: 400px;" id="${meterIDFieldNameData}" name="${meterIDFieldNameData}" class="form-control" readonly="readonly" value="${meterIDData}">
    `;
    formBody.appendChild(formGroup);

    // Diğer alanlar FieldsToUpdate --> CustomName
    formGroup = document.createElement('div');
    formGroup.className = 'form-group';
    formGroup.innerHTML = `
        <label for="CustomName">Sayaç İsmi</label>
        <input type="text" style="width: 400px;" id="CustomName" name="CustomName" class="form-control" value="${customNameData}" required>
    `;
    formBody.appendChild(formGroup);

    // Diğer alanlar FieldsToUpdate --> Note
    formGroup = document.createElement('div');
    formGroup.className = 'form-group';
    formGroup.innerHTML = `
        <label for="Note">Not</label>
        <input type="text" style="width: 400px;" id="Note" name="Note" class="form-control" value="${noteData}" required>
    `;
    formBody.appendChild(formGroup);

    // Diğer alanlar FieldsToUpdate --> IsVisibleInInvoiceReport
    formGroup = document.createElement('div');
    formGroup.className = 'form-group';
    if (isVisibleInInvoiceReportData === true || isVisibleInInvoiceReportData === 'true'){
      formGroup.innerHTML = `
          <label for="IsVisibleInInvoiceReport">Faturalandırma</label>
          <select id="IsVisibleInInvoiceReport" name="IsVisibleInInvoiceReport" class="form-control">
              <option value="true" selected>Evet</option>
              <option value="false" >Hayır</option>
          </select>
      `;
    } else {
      formGroup.innerHTML = `
          <label for="IsVisibleInInvoiceReport">Faturalandırma</label>
          <select id="IsVisibleInInvoiceReport" name="IsVisibleInInvoiceReport" class="form-control">
              <option value="true" >Evet</option>
              <option value="false" selected>Hayır</option>
          </select>
      `;
    }
    formBody.appendChild(formGroup);

    modal.modal('show');
}

function showUpdateSubscriberDataForm(tableName, subscriberData, flatID) {
    console.log(`Güncelleme başlatıldı: Tablo - ${tableName}, FlatID ${flatID}, Abone - ${subscriberData}`);
    // Modal gösterme işlemleri ve diğer işlevler buraya eklenebilir
    const modal = $('#updateDataModal');

    // Set the tableName as a data attribute on the modal
    modal.data('tableName', tableName);

    modal.find('.modal-title').text(`Abone Güncelleme`);
    const form = modal.find('form')[0];
    const formBody = modal.find('.modal-body > form')[0];

    // Clear previous form fields
    formBody.innerHTML = '';
        
    // İlk alan TargetRecord için
    let formGroup = document.createElement('div');
    formGroup.className = 'form-group';
    formGroup.style.display = 'none'; // Form grubunu gizlemek için
    formGroup.innerHTML = `
        <label for="FlatID">FlatID</label>
        <input type="text" style="width: 400px;" id="FlatID" name="FlatID" class="form-control" readonly="readonly" value="${flatID}">
    `;
    formBody.appendChild(formGroup);

    // Diğer alanlar FieldsToUpdate için
    formGroup = document.createElement('div');
    formGroup.className = 'form-group';
    formGroup.innerHTML = `
        <label for="Subscriber">Abone İsmi</label>
        <input type="text" style="width: 400px;" id="Subscriber" name="Subscriber" class="form-control" value="${subscriberData}" required>
    `;
    formBody.appendChild(formGroup);

    modal.modal('show');
}

function showUndefinedMetersForm() {
    // Tabloların bilgileri
    const tables = [
        { name: "ElectricMeters", label: "Elektrik" },
        { name: "HeatingMeters", label: "Kalorimetre (Isıtma)" },
        { name: "CoolingMeters", label: "Kalorimetre (Soğutma)" },
        { name: "WaterMeters", label: "Su" }
    ];

    const modal = document.getElementById('defineMeterModal');
    const selectContainer = modal.querySelector('.undefined-meters-select-input');

    // Yeni bir <select> öğesi oluştur ve eskiyi değiştir
    const newSelect = document.createElement('select');
    newSelect.className = 'undefined-meters-select-input selectivity-input';
    newSelect.innerHTML = '<option value="" disabled selected>Yükleniyor...</option>';

    // Eski <select> öğesini değiştir
    if (selectContainer) {
        selectContainer.replaceWith(newSelect);
    }

    const undefinedMeters = {}; // Sayaçları grup başlıklarına göre saklayacak obje

    // Tabloları sırayla sorgula
    Promise.all(
        tables.map(table =>
            fetch(`${baseWebhookURL}/webhook/get-table-content`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tableName: table.name })
            })
                .then(response => response.json())
                .then(data => {
                    if (data[0].success && Array.isArray(data[0].data)) {
                        // Tanımsız sayaçları filtrele
                        undefinedMeters[table.label] = data[0].data.filter(meter => !meter.RelatedID);
                    }
                })
                .catch(error => console.error(`Hata: ${table.name} sorgulanamadı`, error))
        )
    ).then(() => {
        // Tüm sorgular tamamlandıktan sonra <select> öğesini doldur
        newSelect.innerHTML = ''; // Önce tüm mevcut içeriği temizle

        Object.keys(undefinedMeters).forEach(group => {
            if (undefinedMeters[group].length > 0) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = group;

                undefinedMeters[group].forEach(meter => {
                    const option = document.createElement('option');
                    option.value = meter.SerialNumber;
                    option.textContent = meter.SerialNumber;
                    optgroup.appendChild(option);
                });

                newSelect.appendChild(optgroup);
            }
        });

        // Eğer tanımsız sayaç yoksa
        if (Object.keys(undefinedMeters).every(group => undefinedMeters[group].length === 0)) {
            newSelect.innerHTML = '<option value="" disabled>Tanımsız sayaç bulunamadı</option>';
        }
    }).catch(error => {
        console.error('Sayaç verileri yüklenirken hata oluştu', error);
        newSelect.innerHTML = '<option value="" disabled>Veriler yüklenemedi</option>';
    });

    // Modal başlığı ve gösterimi
    modal.querySelector('.modal-title').textContent = `Aboneye Sayaç Tanımlama`;
    $('#defineMeterModal').modal('show');
}

function removeDefinedMeter(tableName, meterIDFieldNameData, meterIDData) {
    const targetRecord = {};
    const fieldsToUpdate = {};

    targetRecord[meterIDFieldNameData] = meterIDData;
    fieldsToUpdate["RelatedID"] = ""; 

    const jsonData = {
        tableName: tableName,
        TargetRecord: targetRecord,
        FieldsToUpdate: fieldsToUpdate
    };

    $.blockUI({
        message: '<div class="icon-spinner9 icon-spin icon-lg"></div>',
        overlayCSS: { backgroundColor: '#fff', opacity: 0.8, cursor: 'wait' },
        css: { border: 0, padding: 0, backgroundColor: 'transparent' }
    });

    fetch(`${baseWebhookURL}/webhook/update-table-content`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(jsonData)
    })
    .then(response => response.json())
    .then(data => {
        $.unblockUI();
        if (data[0].success) {
            $('#meter-detail-modal').modal('hide');
            location.reload(); // Sayfayı yeniden yükle.
        } else {
            alert('Veri kaldırılırken bir hata oluştu: ' + data[0].message);
        }
    })
    .catch(error => {
        $.unblockUI();
        alert('Veri kaldırılırken bir hata oluştu.');
    });
}

function defineMeter() {
    $.blockUI({
        message: '<div class="icon-spinner9 icon-spin icon-lg"></div>',
        overlayCSS: { backgroundColor: '#fff', opacity: 0.8, cursor: 'wait' },
        css: { border: 0, padding: 0, backgroundColor: 'transparent' }
    });

    // Sayaç tanımlama modalındaki select öğesini seç
    const modal = document.getElementById('defineMeterModal');
    const selectElement = modal.querySelector('.undefined-meters-select-input');

    if (!selectElement) {
        console.error('Select öğesi bulunamadı.');
        return;
    }

    // Seçilen sayaç seri numarasını ve grubu al
    const selectedOption = selectElement.options[selectElement.selectedIndex];
    const selectedGroupLabel = selectedOption.parentElement.label; // Optgroup etiketini al
    const selectedSerialNumber = selectedOption.value;

    // Tabloların bilgileri
    const tables = [
        { name: "ElectricMeters", label: "Elektrik" },
        { name: "HeatingMeters", label: "Kalorimetre (Isıtma)" },
        { name: "CoolingMeters", label: "Kalorimetre (Soğutma)" },
        { name: "WaterMeters", label: "Su" }
    ];

    // Seçilen gruba karşılık gelen tabloyu bul
    const matchedTable = tables.find(table => table.label === selectedGroupLabel);
    const tableName = matchedTable ? matchedTable.name : 'Tablo bulunamadı';

    // FlatID'yi `defined-meters-table` attribute'undan al
    const definedMetersTable = document.getElementById('defined-meters-table');
    const flatID = definedMetersTable?.getAttribute('data-flat-id') || null;

    if (!flatID) {
        console.warn('FlatID değeri bulunamadı.');
    }

    const targetRecord = {};
    const fieldsToUpdate = {};

    targetRecord["SerialNumber"] = selectedSerialNumber;
    fieldsToUpdate["RelatedID"] = flatID; 

    const jsonData = {
        tableName: tableName,
        TargetRecord: targetRecord,
        FieldsToUpdate: fieldsToUpdate
    };

    fetch(`${baseWebhookURL}/webhook/update-table-content`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(jsonData)
    })
    .then(response => response.json())
    .then(data => {
        $.unblockUI();
        if (data[0].success) {
            $('#meter-detail-modal').modal('hide');
            location.reload(); // Sayfayı yeniden yükle.
        } else {
            alert('Sayaç tanımlanırken bir hata oluştu: ' + data[0].message);
        }
    })
    .catch(error => {
        $.unblockUI();
        alert('Sayaç tanımlanırken bir hata oluştu.');
    });
}

  </script>
</body>

</html>